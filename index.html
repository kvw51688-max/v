<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>DIY Poster Creator – Lerine Studio</title>
  <base href="./">

  <!-- Tailwind -->
  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.tailwindcss.com">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- html2canvas & jsPDF -->
  <link rel="preload" href="fonts/inter/inter-regular.woff2" as="font" type="font/woff2" crossorigin>
  <style>
    @font-face { font-family: 'Inter'; src: url('fonts/inter/inter-regular.woff2') format('woff2'); font-weight: 400; font-style: normal; font-display: swap; }
    /* Other font faces omitted for brevity */
    .draggable{ position:absolute; cursor:move; user-select:none; touch-action:none; }
    #previewStage{ width:100%; max-width:960px; margin:0 auto; aspect-ratio:4/5; position:relative; background:#fff; border:1px dashed #cbd5e1; overflow:hidden; }
    #previewBgWrap{ position:absolute; inset:0; overflow:hidden; background:#f3f4f6; }
    #previewBgImg{ width:100%; height:100%; object-fit:cover; display:block; }

    /* Mobile Optimization */
    @media (max-width: 480px) {
      #previewStage { max-width: 100%; }
      .btn { width: auto; }
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div id="iosNotice" class="hidden bg-yellow-50 text-yellow-900 text-sm px-4 py-2">
    Notice: Detected iOS device. If the downloaded print file fails or appears blank, please try setting DPI to 200, or <b>use a computer</b> to export again.
    <button id="closeIosNotice" class="float-right text-yellow-800 hover:underline">Close</button>
  </div>

  <header class="border-b bg-white sticky top-0 z-30">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <h1 class="text-lg md:text-xl font-semibold">DIY Poster Creator – Lerine Studio</h1>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 pb-24 grid grid-cols-1 lg:grid-cols-12 gap-4">
    <section class="lg:col-span-8">
      <div id="tipBar" class="mb-3 text-xs md:text-sm p-2 rounded border bg-blue-50 text-blue-800">
        Click a text to select; <b>double-click</b> (desktop) or <b>long-press 0.6s</b> (mobile) to edit inline.
      </div>

      <div id="previewStage" class="rounded-lg shadow-sm bg-white">
        <div id="previewBgWrap">
          <img id="previewBgImg" alt="background" loading="eager" decoding="async" fetchpriority="high">
        </div>
        <div id="t1" class="draggable text-3xl font-bold" style="left:50%; top:20%; transform:translateX(-50%); text-align:center;">MAIN TITLE</div>
        <div id="t2" class="draggable text-xl" style="left:50%; top:35%; transform:translateX(-50%); text-align:center;">Subtitle goes here</div>
        <div id="t3" class="draggable text-base" style="left:50%; top:50%; transform:translateX(-50%); text-align:center;">Description or notes</div>
      </div>
    </section>

    <aside class="lg:col-span-4">
      <div class="bg-white rounded-xl shadow p-4 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Poster Size (inches)</label>
          <select id="sizeSelect" class="w-full border rounded px-3 py-2">
            <option value="24x30">24 × 30 in</option>
            <option value="24x50">24 × 50 in</option>
          </select>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-sm font-medium mb-1">Print DPI</label>
            <select id="dpiSelect" class="w-full border rounded px-3 py-2">
              <option value="300" selected>300 dpi (print-ready)</option>
              <option value="200">200 dpi (lighter)</option>
            </select>
          </div>
        </div>

        <div class="space-y-2">
          <div class="flex items-center justify-between gap-2">
            <label class="text-sm font-medium">Background</label>
            <div class="flex items-center gap-2">
              <input type="file" id="bgUpload" accept="image/*" class="block w-[180px] text-xs" />
              <button id="resetBg" class="text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">Reset</button>
            </div>
          </div>

          <div class="space-y-2">
            <div id="thumbGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2 rounded border bg-slate-50 p-2"></div>
          </div>
        </div>

        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <span class="text-sm font-medium">Edit Text</span>
            <div class="text-xs space-x-1">
              <button data-target="t1" class="pickTarget px-2 py-1 rounded bg-slate-100">Text 1</button>
              <button data-target="t2" class="pickTarget px-2 py-1 rounded bg-slate-100">Text 2</button>
              <button data-target="t3" class="pickTarget px-2 py-1 rounded bg-slate-100">Text 3</button>
            </div>
          </div>

          <textarea id="textContent" rows="3" class="w-full border rounded px-3 py-2 text-sm" placeholder="Type here…"></textarea>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-xs mb-1">Font size (px)</label>
              <input type="number" id="fontSize" class="w-full border rounded px-2 py-1 text-sm" value="36" min="8" max="300" />
            </div>
            <div>
              <label class="block text-xs mb-1">Color</label>
              <input type="color" id="fontColor" class="w-full h-[36px] border rounded" value="#111827" />
            </div>
          </div>
        </div>

        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <span class="text-sm font-medium">Shadow</span>
            <div class="grid grid-cols-3 gap-2">
              <div>
                <label class="block text-xs mb-1">Shadow strength</label>
                <input type="range" id="shadowStrength" min="0" max="100" value="35" />
              </div>
              <div>
                <label class="block text-xs mb-1">Shadow blur</label>
                <input type="range" id="shadowBlur" min="0" max="30" value="10" />
              </div>
              <div>
                <label class="block text-xs mb-1">Shadow color</label>
                <input type="color" id="shadowColor" value="#000000" class="w-full h-[36px] border rounded" />
              </div>
            </div>
          </div>
        </div>

        <div class="space-y-3 border-t pt-3">
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-sm font-medium mb-1">Safe Margin (in)</label>
              <input type="number" id="safeIn" step="0.0625" value="0.5" class="w-full border rounded px-2 py-1" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Bleed (in)</label>
              <input type="number" id="bleedIn" step="0.0625" value="0.125" class="w-full border rounded px-2 py-1" />
            </div>
          </div>
        </div>
      </div>
    </aside>
  </main>

  <footer class="fixed bottom-0 left-0 right-0 border-t bg-white/95 backdrop-blur z-50" id="actionBar">
    <div class="max-w-6xl mx-auto px-4 py-3 flex flex-col md:flex-row items-center justify-between gap-3">
      <div class="flex items-center gap-2 text-xs md:text-sm">
        <span class="text-slate-600" id="statusMsg">Ready.</span>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <button id="btnSave"  class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm">Save Design</button>
        <button id="btnLoad"  class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm">Load Design</button>
        <button id="btnClear" class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm">Clear Saved</button>

        <span class="hidden md:inline w-px h-6 bg-slate-200 mx-1"></span>

        <button id="btnWebPng"  class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm">Download Web PNG</button>
        <button id="btnPrintPng" class="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-sm">Print PNG (High-Res)</button>
        <button id="btnPrintPdf" class="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm">Print-Ready PDF (Exact Inches)</button>
      </div>
    </div>
  </footer>

  <script>
    // Function to adjust export resolution for mobile
    function adjustExportResolution() {
      const isMobile = window.innerWidth <= 480;
      return isMobile ? 1 : 2;  // Use a lower scale for mobile to speed up the download
    }

    // Update canvas generation for different device resolutions
    async function generateCanvas() {
      const scale = adjustExportResolution(); 
      const canvas = await html2canvas(previewStage, {
        scale: scale,
        backgroundColor: '#ffffff', 
        useCORS: true,
        allowTaint: false,
        logging: false
      });
      return canvas;
    }

    // Function to handle downloading the PNG file with optimized resolution
    async function downloadPNG() {
      try {
        const canvas = await generateCanvas();
        const dataUrl = canvas.toDataURL("image/png");
        const a = document.createElement('a');
        a.href = dataUrl;
        a.download = `poster-${state.size}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        status('Download successful.');
      } catch (e) {
        console.error('Error during PNG download', e);
        status('Failed to generate PNG.');
      }
    }

    // Function to handle downloading the PDF file
    async function downloadPDF() {
      try {
        const canvas = await generateCanvas();
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        const imgData = canvas.toDataURL('image/jpeg');
        pdf.addImage(imgData, 'JPEG', 0, 0, state.inches.w, state.inches.h);
        pdf.save(`poster-${state.size}-print.pdf`);
        status('PDF download successful.');
      } catch (e) {
        console.error('Error during PDF download', e);
        status('Failed to generate PDF.');
      }
    }

    // Export buttons
    btnWebPng.addEventListener('click', downloadPNG);
    btnPrintPng.addEventListener('click', downloadPNG);
    btnPrintPdf.addEventListener('click', downloadPDF);

    // Function to cache background image to improve loading time
    function cacheBackgroundImage(src) {
      const img = new Image();
      img.src = src;
      img.onload = function () {
        localStorage.setItem('bgImageCache', src);
      };
    }

    // Function to load cached background image
    function loadCachedBackground() {
      const cachedImage = localStorage.getItem('bgImageCache');
      if (cachedImage) {
        previewBgImg.src = cachedImage;
      } else {
        previewBgImg.src = state.preview.bgSmall || DEFAULT_BG[state.size].small;
        cacheBackgroundImage(previewBgImg.src);
      }
    }

    // Apply the cached or default background image
    function applyPreviewBg() {
      previewBgImg.onload = () => {
        loadCachedBackground();
      };
      previewBgImg.src = state.preview.bgSmall || DEFAULT_BG[state.size].small;
    }

    loadCachedBackground();
  </script>
</body>
</html>
