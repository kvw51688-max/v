<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>DIY Poster Creator – 24×30 / 24×50 in</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- html2canvas & jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto:wght@400;700&family=Open+Sans:wght@400;700&family=Lato:wght@400;700&family=Montserrat:wght@400;700&family=Poppins:wght@400;700&family=Nunito:wght@400;700&family=Source+Sans+3:wght@400;700&family=Ubuntu:wght@400;700&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Pacifico&family=Sacramento&family=Dancing+Script:wght@400;700&family=Indie+Flower&family=Great+Vibes&family=Satisfy&family=Patrick+Hand&family=Amatic+SC:wght@400;700&family=Shadows+Into+Light&display=swap" rel="stylesheet">

  <style>
    .draggable{
      position:absolute; cursor:move; user-select:none; touch-action:none;
      white-space:pre-wrap; line-height:1.15;
      transition: box-shadow .15s ease, outline-color .15s ease, outline-offset .15s ease;
    }
    .draggable.active{
      outline:2px dashed #6366f1;
      outline-offset:2px;
    }
    .draggable.editing{
      cursor:text;
      outline:2px solid #6366f1;
      outline-offset:2px;
      box-shadow: 0 0 0 4px rgba(99,102,241,.15);
    }

    #previewStage{
      width:100%; max-width:960px; margin:0 auto; aspect-ratio:4/5;
      position:relative; background:#fff; border:1px dashed #cbd5e1; overflow:hidden;
    }
    #previewBgWrap{ position:absolute; inset:0; overflow:hidden; background:#f3f4f6; }
    #previewBgImg{ width:100%; height:100%; object-fit:cover; display:block; }

    #printStage{ position:fixed; left:-99999px; top:-99999px; background:#fff; overflow:hidden; }
    .guide{ position:absolute; left:0; right:0; top:50%; height:1px; background:rgba(0,0,0,.08); }
    .guide.v{ top:0; bottom:0; left:50%; width:1px; height:auto; }

    /* 缩略图栅格与懒加载 */
    .thumb-grid{ display:grid; grid-template-columns: repeat(3,minmax(0,1fr)); gap:8px; }
    @media (min-width:480px){ .thumb-grid{ grid-template-columns: repeat(4,minmax(0,1fr)); } }
    @media (min-width:768px){ .thumb-grid{ grid-template-columns: repeat(5,minmax(0,1fr)); } }
    .thumb-btn{
      position:relative; border:2px solid transparent; border-radius:10px; overflow:hidden; background:#e5e7eb;
      aspect-ratio:3/2; display:block;
    }
    .thumb-btn.active{ outline:2px solid #6366f1; border-color:#6366f1; }
    .thumb-img{ width:100%; height:100%; object-fit:cover; display:block; }
    .thumb-skeleton{
      position:absolute; inset:0; background:linear-gradient(90deg,#e5e7eb,#f3f4f6,#e5e7eb);
      background-size:200% 100%; animation: shimmer 1.2s infinite linear;
    }
    @keyframes shimmer{ 0%{background-position:200% 0;} 100%{background-position:-200% 0;} }
    /* 可访问的键盘聚焦 */
    .thumb-btn:focus-visible{
      outline: 2px solid #0ea5e9;
      outline-offset: 2px;
    }

    /* 浮动工具条与a11y状态区 */
    .gp5-inline-toolbar{
      position: fixed;
      right: 12px;
      bottom: 12px;
      z-index: 9999;
      display: flex;
      gap: 8px;
      background: rgba(248,250,252,0.95);
      border: 1px solid rgba(100,116,139,0.25);
      border-radius: 12px;
      padding: 8px 10px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      backdrop-filter: blur(6px);
    }
    .gp5-inline-toolbar button{
      font: 12px/1 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(100,116,139,0.30);
      background: white;
      cursor: pointer;
    }
    .gp5-inline-toolbar button:hover{ background: #f1f5f9; }
    .gp5-editing-highlight{ outline: 1.5px dashed #94a3b8; outline-offset: 2px; }
    #statusMsg[role="status"]{
      position: fixed; left: 12px; bottom: 12px; z-index: 9998;
      background: rgba(17,24,39,0.8); color: white; padding: 6px 10px; border-radius: 10px;
      font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Header -->
  <header class="border-b bg-white sticky top-0 z-30">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <h1 class="text-lg md:text-xl font-semibold">DIY Poster Creator</h1>
      <div class="flex items-center gap-2 text-sm">
        <span class="px-2 py-1 rounded bg-slate-100">24×30 / 24×50 in</span>
        <span class="hidden md:inline text-slate-500">Preview 1920px • Print 300/200 dpi</span>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-4">
    <!-- Preview -->
    <section class="lg:col-span-8">
      <div id="tipBar" class="mb-3 text-xs md:text-sm p-2 rounded border bg-blue-50 text-blue-800">
        Click a text to select; <b>double-click</b> (desktop) or <b>long-press 0.6s</b> (mobile) to edit inline.
        Press <kbd>Esc</kbd> or tap outside to finish. Export at <b>300 dpi</b> (auto-fall back to <b>200 dpi</b> if too large).
      </div>

      <div id="previewStage" class="rounded-lg shadow-sm bg-white">
        <div id="previewBgWrap"><img id="previewBgImg" alt="background"></div>
        <div class="guide hidden" id="guideH"></div>
        <div class="guide v hidden" id="guideV"></div>

        <!-- Draggable texts (百分比定位) -->
        <div id="t1" class="draggable text-3xl font-bold" style="left:10%; top:10%;">MAIN TITLE</div>
        <div id="t2" class="draggable text-xl" style="left:10%; top:25%;">Subtitle goes here</div>
        <div id="t3" class="draggable text-base" style="left:10%; top:40%;">Description or notes</div>
      </div>

      <div class="mt-3 text-xs md:text-sm text-slate-600" id="specInfo"></div>
    </section>

    <!-- Controls -->
    <aside class="lg:col-span-4">
      <div class="bg-white rounded-xl shadow p-4 space-y-4">
        <!-- Size -->
        <div>
          <label class="block text-sm font-medium mb-1">Poster Size (inches)</label>
          <select id="sizeSelect" class="w-full border rounded px-3 py-2" aria-label="Choose poster size in inches">
            <option value="24x30">24 × 30 in (preview 1920×2400)</option>
            <option value="24x50">24 × 50 in (preview 1920×4000)</option>
          </select>
        </div>

        <!-- DPI + Guides -->
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-sm font-medium mb-1">Print DPI</label>
            <select id="dpiSelect" class="w-full border rounded px-3 py-2" aria-label="Choose print DPI">
              <option value="300" selected>300 dpi (print-ready)</option>
              <option value="200">200 dpi (lighter)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Guides</label>
            <select id="guideSelect" class="w-full border rounded px-3 py-2" aria-label="Toggle center guides">
              <option value="off" selected>Off</option>
              <option value="on">Show center guides</option>
            </select>
          </div>
        </div>

        <!-- Background picker -->
        <div class="space-y-2">
          <div class="flex items-center justify-between gap-2">
            <label class="text-sm font-medium">Backgrounds</label>
            <div class="flex items-center gap-2">
              <input type="file" id="bgUpload" accept="image/*" class="block w-[180px] text-xs" aria-label="Upload custom background image" />
              <button id="resetBg" class="text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200" aria-label="Reset to default background">Reset</button>
            </div>
          </div>

          <!-- 缩略图分页栅格 -->
          <div class="space-y-2">
            <div id="thumbGrid" class="thumb-grid rounded border bg-slate-50 p-2"></div>
            <div class="flex items-center justify-between">
              <div class="text-xs text-slate-500" id="pageInfo">Page 1 / 1</div>
              <div class="flex items-center gap-1">
                <button id="pageFirst" class="px-2 py-1 text-xs rounded bg-slate-100 hover:bg-slate-200" aria-label="Go to first page">« First</button>
                <button id="pagePrev"  class="px-2 py-1 text-xs rounded bg-slate-100 hover:bg-slate-200" aria-label="Go to previous page">‹ Prev</button>
                <button id="pageNext"  class="px-2 py-1 text-xs rounded bg-slate-100 hover:bg-slate-200" aria-label="Go to next page">Next ›</button>
                <button id="pageLast"  class="px-2 py-1 text-xs rounded bg-slate-100 hover:bg-slate-200" aria-label="Go to last page">Last »</button>
              </div>
            </div>
          </div>

          <p class="text-xs text-slate-500">
            Tip: Thumbnails are lazy-loaded. Print uses originals at 300/200 dpi. Local uploads are embedded and added to the library.
          </p>
        </div>

        <!-- Text editor -->
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <span class="text-sm font-medium">Edit Text</span>
            <div class="text-xs space-x-1">
              <button data-target="t1" class="pickTarget px-2 py-1 rounded bg-slate-100" aria-label="Edit text block 1">Text 1</button>
              <button data-target="t2" class="pickTarget px-2 py-1 rounded bg-slate-100" aria-label="Edit text block 2">Text 2</button>
              <button data-target="t3" class="pickTarget px-2 py-1 rounded bg-slate-100" aria-label="Edit text block 3">Text 3</button>
            </div>
          </div>

          <textarea id="textContent" rows="3" class="w-full border rounded px-3 py-2 text-sm" placeholder="Type here…" aria-label="Edit selected text"></textarea>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-xs mb-1">Font size (preview px)</label>
              <input type="number" id="fontSize" class="w-full border rounded px-2 py-1 text-sm" value="36" min="8" max="300" aria-label="Font size in pixels for preview" />
            </div>
            <div>
              <label class="block text-xs mb-1">Color</label>
              <input type="color" id="fontColor" class="w-full h-[36px] border rounded" value="#111827" aria-label="Font color" />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-xs mb-1">Font family</label>
              <select id="fontFamily" class="w-full border rounded px-2 py-1 text-sm" aria-label="Font family">
                <!-- Sans -->
                <option value="'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif">Inter (Sans)</option>
                <option value="'Roboto', system-ui, -apple-system, Segoe UI, Arial, sans-serif">Roboto (Sans)</option>
                <option value="'Open Sans', system-ui, -apple-system, Segoe UI, Arial, sans-serif">Open Sans (Sans)</option>
                <option value="'Lato', system-ui, -apple-system, Segoe UI, Arial, sans-serif">Lato (Sans)</option>
                <option value="'Montserrat', system-ui, -apple-system, Segoe UI, Arial, sans-serif">Montserrat (Sans)</option>
                <option value="'Poppins', system-ui, -apple-system, Segoe UI, Arial, sans-serif">Poppins (Sans)</option>
                <option value="'Nunito', system-ui, -apple-system, Segoe UI, Arial, sans-serif">Nunito (Sans)</option>
                <option value="'Source Sans 3', system-ui, -apple-system, Segoe UI, Arial, sans-serif">Source Sans 3 (Sans)</option>
                <option value="'Ubuntu', system-ui, -apple-system, Segoe UI, Arial, sans-serif">Ubuntu (Sans)</option>
                <option value="'Noto Sans', system-ui, -apple-system, Segoe UI, Arial, sans-serif">Noto Sans (Sans)</option>
                <!-- Handwriting -->
                <option value="'Caveat', 'Comic Sans MS', cursive">Caveat (Handwriting)</option>
                <option value="'Pacifico', 'Comic Sans MS', cursive">Pacifico (Handwriting)</option>
                <option value="'Sacramento', 'Comic Sans MS', cursive">Sacramento (Handwriting)</option>
                <option value="'Dancing Script', 'Comic Sans MS', cursive">Dancing Script (Handwriting)</option>
                <option value="'Indie Flower', 'Comic Sans MS', cursive">Indie Flower (Handwriting)</option>
                <option value="'Great Vibes', 'Comic Sans MS', cursive">Great Vibes (Handwriting)</option>
                <option value="'Satisfy', 'Comic Sans MS', cursive">Satisfy (Handwriting)</option>
                <option value="'Patrick Hand', 'Comic Sans MS', cursive">Patrick Hand (Handwriting)</option>
                <option value="'Amatic SC', 'Comic Sans MS', cursive">Amatic SC (Handwriting)</option>
                <option value="'Shadows Into Light', 'Comic Sans MS', cursive">Shadows Into Light (Handwriting)</option>
              </select>
            </div>
            <div class="flex flex-wrap items-center gap-2 text-xs">
              <label class="inline-flex items-center gap-1 mt-6"><input type="checkbox" id="bold"> Bold</label>
              <label class="inline-flex items-center gap-1 mt-6"><input type="checkbox" id="italic"> Italic</label>
              <label class="inline-flex items-center gap-1 mt-6"><input type="checkbox" id="underline"> Underline</label>
              <select id="align" class="border rounded px-2 py-1 mt-5" aria-label="Text alignment">
                <option value="left">Left</option>
                <option value="center">Center</option>
                <option value="right">Right</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-3 gap-2">
            <div>
              <label class="block text-xs mb-1">Shadow strength</label>
              <input type="range" id="shadowStrength" min="0" max="100" value="35" aria-label="Text shadow strength" />
            </div>
            <div>
              <label class="block text-xs mb-1">Shadow blur</label>
              <input type="range" id="shadowBlur" min="0" max="30" value="10" aria-label="Text shadow blur" />
            </div>
            <div>
              <label class="block text-xs mb-1">Shadow color</label>
              <input type="color" id="shadowColor" value="#000000" class="w-full h-[36px] border rounded" aria-label="Text shadow color" />
            </div>
          </div>
        </div>
      </div>
    </aside>
  </main>

  <!-- Footer -->
  <footer class="fixed bottom-0 left-0 right-0 border-t bg-white/95 backdrop-blur z-40">
    <div class="max-w-6xl mx-auto px-4 py-3 flex flex-col md:flex-row items-center justify-between gap-3">
      <div class="text-xs md:text-sm text-slate-600" id="statusMsg">Ready. Pick a size & background, position your texts, then export.</div>
      <div class="flex flex-wrap items-center gap-2">
        <button id="btnWebPng"  class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm" aria-label="Download web PNG at 1920 pixels">Download Web PNG (1920px)</button>
        <button id="btnPrintPng" class="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-sm" aria-label="Download print-ready PNG at selected DPI">Download Print PNG (DPI)</button>
        <button id="btnPrintPdf" class="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm" aria-label="Download print-ready PDF with true inches">Download Print PDF (true inches)</button>
      </div>
    </div>
  </footer>

  <div id="printStage"></div>

  <script>
    // ---------- Fonts helper ----------
    async function ensureFontsReady(){
      if (document.fonts && document.fonts.ready) {
        try { await document.fonts.ready; } catch(_){}
      }
    }

    // ---------- Default backgrounds for each size ----------
    const DEFAULT_BG = {
      '24x30': {
        small: 'https://kvw51688-max.github.io/v/24-30-1.webp',
        large: 'https://kvw51688-max.github.io/v/24-30-1.png'
      },
      '24x50': {
        small: 'https://kvw51688-max.github.io/v/24-50-1.webp',
        large: 'https://kvw51688-max.github.io/v/24-50-1.png'
      }
    };

    // ---------- Library ----------
    const ASSET_LIBRARY = [
      { id:'lib-2430-1', label:'24×30 – BG #1', size:'24x30',
        small:'https://kvw51688-max.github.io/v/24-30-1.webp',
        large:'https://kvw51688-max.github.io/v/24-30-1.png' },
      { id:'lib-2430-2', label:'24×30 – BG #2', size:'24x30',
        small:'https://kvw51688-max.github.io/v/assets/images-small/24-30-2.png',
        large:'https://kvw51688-max.github.io/v/assets/images-small/24-30-2.png' },
      { id:'lib-2450-1', label:'24×50 – BG #1', size:'24x50',
        small:'https://kvw51688-max.github.io/v/24-50-1.webp',
        large:'https://kvw51688-max.github.io/v/24-50-1.png' },
      { id:'lib-2450-2', label:'24×50 – BG #2', size:'24x50',
        small:'https://kvw51688-max.github.io/v/assets/images-small/24-50-2.png',
        large:'https://kvw51688-max.github.io/v/assets/images-small/24-50-2.png' }
    ];

    // ---------- Pagination Config ----------
    const PAGE_SIZE = 12;

    // ---------- State ----------
    const state = {
      size:'24x30',
      dpi:300,
      preview:{
        width:1920, height:2400,
        bgSmall: DEFAULT_BG['24x30'].small,
        bgLarge: DEFAULT_BG['24x30'].large,
        isLocal:false
      },
      inches:{w:24, h:30},
      activeTextId:'t1',
      activeThumbId:null,
      inlineEditing:null,
      picks: { '24x30': null, '24x50': null },
      pageIndex: { '24x30': 0, '24x50': 0 }
    };

    // ---------- Elements ----------
    const previewStage = document.getElementById('previewStage');
    const previewBgImg = document.getElementById('previewBgImg');
    const printStage   = document.getElementById('printStage');

    const t1=document.getElementById('t1');
    const t2=document.getElementById('t2');
    const t3=document.getElementById('t3');
    const texts={t1,t2,t3};

    const sizeSelect  =document.getElementById('sizeSelect');
    const dpiSelect   =document.getElementById('dpiSelect');
    const guideSelect =document.getElementById('guideSelect');
    const specInfo    =document.getElementById('specInfo');
    const statusMsg   =document.getElementById('statusMsg');

    const textContent =document.getElementById('textContent');
    const fontSize    =document.getElementById('fontSize');
    const fontColor   =document.getElementById('fontColor');
    const bold        =document.getElementById('bold');
    const italic      =document.getElementById('italic');
    const underline   =document.getElementById('underline');
    const align       =document.getElementById('align');
    const fontFamily  =document.getElementById('fontFamily');

    const shadowStrength=document.getElementById('shadowStrength');
    const shadowBlur    =document.getElementById('shadowBlur');
    const shadowColor   =document.getElementById('shadowColor');

    const guideH=document.getElementById('guideH');
    const guideV=document.getElementById('guideV');

    const btnWebPng =document.getElementById('btnWebPng');
    const btnPrintPng=document.getElementById('btnPrintPng');
    const btnPrintPdf=document.getElementById('btnPrintPdf');

    const resetBg=document.getElementById('resetBg');

    const bgUpload =document.getElementById('bgUpload');
    const thumbGrid=document.getElementById('thumbGrid');
    const pageInfo =document.getElementById('pageInfo');
    const pageFirst=document.getElementById('pageFirst');
    const pagePrev =document.getElementById('pagePrev');
    const pageNext =document.getElementById('pageNext');
    const pageLast =document.getElementById('pageLast');

    // ---------- Utility ----------
    function status(msg){ statusMsg.textContent=msg; }
    function rgbToHex(rgb){
      const m=rgb.match(/\d+/g); if(!m) return '#000000';
      const [r,g,b]=m.map(Number);
      return '#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');
    }
    function cssColorToHex(c){ if(c.startsWith('#')) return c; return rgbToHex(getComputedStyle(Object.assign(document.createElement('div'),{style:{color:c}})).color); }

    function shouldDownscale(wPx, hPx) {
      const MAX_SIDE   = 10000;
      const MAX_PIXELS = 80e6;
      return (wPx > MAX_SIDE || hPx > MAX_SIDE || (wPx*hPx) > MAX_PIXELS);
    }

    function safeSessionSet(key, value) {
      try { sessionStorage.setItem(key, value); }
      catch(e) {
        console.warn('Session quota exceeded', e);
        status('Tip: thumbnail storage is full; new uploads may not be remembered.');
      }
    }

    async function makeThumbnail(dataUrl, maxW=480, quality=0.85){
      return new Promise((resolve)=>{
        const img = new Image();
        img.onload = ()=>{
          const scale = Math.min(1, maxW / img.naturalWidth);
          const w = Math.round(img.naturalWidth * scale);
          const h = Math.round(img.naturalHeight * scale);
          const c = document.createElement('canvas');
          c.width = w; c.height = h;
          const ctx = c.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          resolve(c.toDataURL('image/jpeg', quality));
        };
        img.src = dataUrl;
      });
    }

    // Busy wrapper for buttons
    async function withBusy(el, fn){
      const old = el.textContent;
      el.disabled = true;
      el.textContent = 'Working...';
      el.classList.add('opacity-70','cursor-wait');
      try { await fn(); }
      catch(e){ console.error(e); alert('Export failed. Try 200 DPI or a smaller image.'); }
      finally{
        el.disabled = false;
        el.textContent = old;
        el.classList.remove('opacity-70','cursor-wait');
      }
    }

    // Lock/unlock page scroll during heavy render
    function lockScroll(){ document.body.style.overflow='hidden'; }
    function unlockScroll(){ document.body.style.overflow=''; }

    // ---------- Active highlight ----------
    function setActiveText(id){
      state.activeTextId = id;
      for (const el of Object.values(texts)) el.classList.remove('active');
      texts[id]?.classList.add('active');
      loadTextEditorFrom(id);
    }

    // ---------- Click / Double-Click & Long-Press ----------
    function attachClickToEdit(el){
      el.addEventListener('click', (e)=>{
        if (state.inlineEditing && state.inlineEditing !== el.id) return;
        setActiveText(el.id);
        e.stopPropagation();
      });

      el.addEventListener('dblclick', (e)=>{
        if (isMobileDevice()) return;
        enterInlineEdit(el);
        e.preventDefault(); e.stopPropagation();
      });

      enableLongPressEdit(el);

      el.addEventListener('mousedown', (e)=>{
        if (el.classList.contains('editing')) e.stopPropagation();
      });

      el.addEventListener('blur', ()=>{
        if (el.classList.contains('editing')) exitInlineEdit(el);
      });

      el.addEventListener('keydown', (e)=>{
        if (!el.classList.contains('editing')) return;
        if (e.key === 'Escape'){ e.preventDefault(); exitInlineEdit(el, true); return; }
        queueMicrotask(()=>{
          if (state.activeTextId === el.id) textContent.value = el.innerText;
        });
      });
    }

    function enableLongPressEdit(el){
      let timer=null;
      el.addEventListener('touchstart', ()=>{
        if (el.classList.contains('editing')) return;
        timer = setTimeout(()=> enterInlineEdit(el), 600);
      }, {passive:true});
      ['touchend','touchmove','touchcancel'].forEach(ev=>{
        el.addEventListener(ev, ()=> { if (timer) { clearTimeout(timer); timer=null; } }, {passive:true});
      });
    }

    function isMobileDevice(){ return /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent); }
    function isIOS(){ return /iP(hone|ad|od)/i.test(navigator.userAgent); }

    function enterInlineEdit(el){
      if (state.inlineEditing && texts[state.inlineEditing]) exitInlineEdit(texts[state.inlineEditing]);
      setActiveText(el.id);
      state.inlineEditing = el.id;
      el.classList.add('editing');
      try{ el.setAttribute('contenteditable', 'plaintext-only'); }catch(_){ el.setAttribute('contenteditable', 'true'); }
      // 移动端进入编辑时锁滚动
      if(isMobileDevice()) lockScroll();
      el.focus(); placeCaretAtEnd(el);
      status('Inline editing… Press Esc or tap outside to finish.');
    }
    function exitInlineEdit(el, keepFocusOutside=false){
      el.removeAttribute('contenteditable');
      el.classList.remove('editing');
      state.inlineEditing = null;
      if (state.activeTextId === el.id) textContent.value = el.innerText;
      if (!keepFocusOutside) previewStage.focus?.();
      if(isMobileDevice()) unlockScroll();
      status('Editing finished.');
    }
    function placeCaretAtEnd(el){
      const range = document.createRange();
      const sel = window.getSelection();
      range.selectNodeContents(el);
      range.collapse(false);
      sel.removeAllRanges(); sel.addRange(range);
    }
    document.addEventListener('click', (e)=>{
      if (!state.inlineEditing) return;
      const editingEl = texts[state.inlineEditing];
      if (editingEl && !editingEl.contains(e.target)) exitInlineEdit(editingEl);
    });

    // ---------- Text target picker ----------
    for(const el of document.querySelectorAll('.pickTarget')){
      el.addEventListener('click',()=> setActiveText(el.dataset.target));
    }

    // ---------- Size / DPI ----------
    function setSize(v){
      // 记住当前尺寸的选择
      state.picks[state.size] = {
        id: state.activeThumbId,
        small: state.preview.bgSmall,
        large: state.preview.bgLarge,
        isLocal: state.preview.isLocal
      };
      state.size=v;

      if(v==='24x30'){ state.preview.height=2400; state.inches={w:24,h:30}; previewStage.style.aspectRatio='4 / 5'; }
      else           { state.preview.height=4000; state.inches={w:24,h:50}; previewStage.style.aspectRatio='24 / 50'; }

      // iOS + 24×50：强制 200 DPI 更稳
      if(isIOS() && v==='24x50'){
        dpiSelect.value='200';
        setDpi(200);
        status('On iPhone: 200 DPI set to improve stability.');
      }

      const pick = state.picks[v];
      if (pick && pick.small && pick.large){
        state.preview.isLocal = !!pick.isLocal;
        state.preview.bgSmall = pick.small;
        state.preview.bgLarge = pick.large;
        state.activeThumbId   = pick.id || null;
      } else {
        state.preview.isLocal = false;
        state.preview.bgSmall = DEFAULT_BG[v].small;
        state.preview.bgLarge = DEFAULT_BG[v].large;
        state.activeThumbId   = null;
      }

      applyPreviewBg();
      updateSpecInfo();

      if(state.pageIndex[v] == null) state.pageIndex[v] = 0;
      buildThumbs();
      clampPositionsToStage();
    }

    function setDpi(v){
      state.dpi=parseInt(v,10);
      updateSpecInfo();
      warnIfLocalTooSmall();
    }

    // ---------- Spec / Preview ----------
    function updateSpecInfo(){
      const {w,h}=state.inches;
      const pw=state.preview.width, ph=state.preview.height;
      const printWpx=Math.round(w*state.dpi), printHpx=Math.round(h*state.dpi);
      specInfo.innerHTML = `<b>Spec:</b> Preview ${pw}×${ph} px • Print ${w}×${h} in @ ${state.dpi} dpi → <b>${printWpx}×${printHpx} px</b>`;
    }

    function applyPreviewBg(){
      const url=state.preview.bgSmall;
      if (!url) { previewBgImg.removeAttribute('src'); return; }
      previewBgImg.crossOrigin = 'anonymous';
      previewBgImg.src = url;
    }

    sizeSelect.addEventListener('change',e=>setSize(e.target.value));
    dpiSelect.addEventListener('change',e=>setDpi(e.target.value));
    guideSelect.addEventListener('change',e=>{
      const on=e.target.value==='on';
      document.getElementById('guideH').classList.toggle('hidden',!on);
      document.getElementById('guideV').classList.toggle('hidden',!on);
    });

    // ---------- Library helpers ----------
    function loadLocalThumbs(size){
      const key=`localThumbs_${size}`;
      try{ return JSON.parse(sessionStorage.getItem(key)||'[]'); }catch{ return []; }
    }
    function saveLocalThumb(size,item){
      const key=`localThumbs_${size}`;
      const arr=loadLocalThumbs(size);
      if(!arr.some(i=>i.small===item.small)){
        arr.unshift(item);
        safeSessionSet(key, JSON.stringify(arr.slice(0,30)));
      }
    }
    function getAllItemsForSize(size){
      const locals=loadLocalThumbs(size);
      const items=ASSET_LIBRARY.filter(i=>i.size===size);
      return [...locals, ...items];
    }

    // ---------- Lazy loader for images ----------
    let io = null;
    function ensureIO(){
      if(io) return io;
      io = new IntersectionObserver((entries)=>{
        entries.forEach(entry=>{
          if(entry.isIntersecting){
            const img = entry.target;
            const src = img.getAttribute('data-src');
            if(src){
              img.src = src;
              img.onload = ()=> img.parentElement?.querySelector('.thumb-skeleton')?.remove?.();
              img.onerror = ()=> img.parentElement?.querySelector('.thumb-skeleton')?.remove?.();
              img.removeAttribute('data-src');
            }
            io.unobserve(img);
          }
        });
      }, {root: null, rootMargin:'100px', threshold: 0.01});
      return io;
    }

    // ---------- Build thumbs with pagination ----------
    function buildThumbs(){
      thumbGrid.innerHTML='';
      const size = state.size;
      const all = getAllItemsForSize(size);
      const total = all.length || 1;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      const page = Math.min(Math.max(0, state.pageIndex[size] || 0), totalPages - 1);
      state.pageIndex[size] = page;

      const start = page * PAGE_SIZE;
      const end = Math.min(total, start + PAGE_SIZE);
      const pageItems = all.slice(start, end);

      // Render each thumb (lazy)
      const _io = ensureIO();

      pageItems.forEach(item=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'thumb-btn';
        btn.title = item.label || 'Background';
        btn.dataset.small = item.small;
        btn.dataset.large = item.large || item.small;
        btn.dataset.id = item.id || '';
        btn.setAttribute('aria-label', item.label || 'Background thumbnail');
        if(state.activeThumbId && state.activeThumbId===item.id){ btn.classList.add('active'); }

        const sk = document.createElement('div');
        sk.className = 'thumb-skeleton';
        btn.appendChild(sk);

        const img = document.createElement('img');
        img.className = 'thumb-img';
        img.setAttribute('loading','lazy');
        img.setAttribute('alt', item.label || 'background');
        img.setAttribute('data-src', item.small);
        btn.appendChild(img);

        _io.observe(img);

        btn.addEventListener('click',()=>{
          state.preview.isLocal = !!item.isLocal;
          state.preview.bgSmall = item.small;
          state.preview.bgLarge = item.large || item.small;
          state.activeThumbId   = item.id || null;

          state.picks[state.size] = {
            id: state.activeThumbId,
            small: state.preview.bgSmall,
            large: state.preview.bgLarge,
            isLocal: state.preview.isLocal
          };

          document.querySelectorAll('.thumb-btn').forEach(n=>n.classList.remove('active'));
          btn.classList.add('active');
          applyPreviewBg();
          warnIfLocalTooSmall(item.naturalW, item.naturalH);
          status(item.isLocal?'Local background selected.':'Background set from repository assets.');
        });

        thumbGrid.appendChild(btn);
      });

      // Page UI
      pageInfo.textContent = `Page ${page+1} / ${totalPages}`;
      pageFirst.disabled = (page === 0);
      pagePrev.disabled  = (page === 0);
      pageNext.disabled  = (page >= totalPages-1);
      pageLast.disabled  = (page >= totalPages-1);
    }

    // ---------- Pagination actions ----------
    pageFirst.addEventListener('click', ()=>{ state.pageIndex[state.size]=0; buildThumbs(); });
    pagePrev .addEventListener('click', ()=>{
      state.pageIndex[state.size]=Math.max(0,(state.pageIndex[state.size]||0)-1); buildThumbs();
    });
    pageNext .addEventListener('click', ()=>{
      const all = getAllItemsForSize(state.size);
      const totalPages = Math.max(1, Math.ceil(all.length / PAGE_SIZE));
      state.pageIndex[state.size]=Math.min(totalPages-1,(state.pageIndex[state.size]||0)+1); buildThumbs();
    });
    pageLast .addEventListener('click', ()=>{
      const all = getAllItemsForSize(state.size);
      const totalPages = Math.max(1, Math.ceil(all.length / PAGE_SIZE));
      state.pageIndex[state.size]=totalPages-1; buildThumbs();
    });

    // ---------- Local upload ----------
    bgUpload.addEventListener('change', async(e)=>{
      const file=e.target.files?.[0]; if(!file) return;
      const dataUrl=await readFileAsDataURL(file);

      const img=new Image();
      img.onload=async ()=>{
        const thumb = await makeThumbnail(dataUrl, 480, 0.85);
        const item={
          id:`local-${Date.now()}`, label:`${state.size} – Local upload`,
          size:state.size, small:thumb, large:dataUrl, isLocal:true,
          naturalW:img.naturalWidth, naturalH:img.naturalHeight
        };
        state.preview.isLocal=true;
        state.preview.bgSmall=item.small;
        state.preview.bgLarge=item.large;
        state.activeThumbId=item.id;

        state.picks[state.size] = {
          id: state.activeThumbId,
          small: state.preview.bgSmall,
          large: state.preview.bgLarge,
          isLocal: true
        };

        applyPreviewBg();
        saveLocalThumb(state.size,item);

        state.pageIndex[state.size] = 0;
        buildThumbs();
        warnIfLocalTooSmall(img.naturalWidth,img.naturalHeight);
        status('Local background uploaded and added to the library.');
        bgUpload.value='';
      };
      img.src=dataUrl;
    });

    async function readFileAsDataURL(file){
      return new Promise((resolve,reject)=>{
        const fr=new FileReader();
        fr.onload=()=>resolve(fr.result);
        fr.onerror=reject;
        fr.readAsDataURL(file);
      });
    }

    // ---------- Text editor <-> preview ----------
    function loadTextEditorFrom(id){
      const el=texts[id];
      if (!el) return;
      for (const n of Object.values(texts)) n.classList.remove('active');
      el.classList.add('active');

      textContent.value=el.innerText;
      const cs=getComputedStyle(el);
      fontSize.value=parseInt(cs.fontSize,10);
      fontColor.value=rgbToHex(cs.color);

      const fam=cs.fontFamily;
      const opts=Array.from(fontFamily.options);
      const found=opts.find(o=>fam.toLowerCase().includes(o.value.split(',')[0].replace(/['"]/g,'').toLowerCase()));
      if(found) fontFamily.value=found.value;

      bold.checked=cs.fontWeight==='700'||parseInt(cs.fontWeight,10)>=600;
      italic.checked=cs.fontStyle==='italic';
      underline.checked=(cs.textDecorationLine||'').includes('underline');
      align.value=cs.textAlign||'left';

      const shadow=cs.textShadow||'';
      const m=shadow.match(/(-?\d+\.?\d*)px\s+(-?\d+\.?\d*)px\s+(\d+\.?\d*)px\s+(rgba?\([^)]+\)|#[0-9a-fA-F]{3,8})/);
      if(m){
        shadowStrength.value=Math.min(100, Math.round(Math.hypot(parseFloat(m[1]),parseFloat(m[2]))));
        shadowBlur.value=parseInt(m[3],10);
        shadowColor.value=cssColorToHex(m[4]);
      }else{
        shadowStrength.value=35; shadowBlur.value=10; shadowColor.value='#000000';
      }
    }

    function applyEditorTo(id){
      const el=texts[id];
      if (!el) return;
      el.innerText=textContent.value;
      el.style.fontSize=`${parseInt(fontSize.value,10)}px`;
      el.style.color=fontColor.value;
      el.style.fontWeight=bold.checked?'700':'400';
      el.style.fontStyle=italic.checked?'italic':'normal';
      el.style.textDecoration=underline.checked?'underline':'none';
      el.style.textAlign=align.value;
      el.style.fontFamily=fontFamily.value;

      const s=parseInt(shadowStrength.value,10);
      const blur=parseInt(shadowBlur.value,10);
      const off=Math.round(s/10);
      el.style.textShadow = s===0 ? 'none' : `${off}px ${off}px ${blur}px ${shadowColor.value}`;
      // store shadow params for export
      el.dataset.shadowS = String(s);
      el.dataset.shadowBlur = String(blur);
      el.dataset.shadowColor = shadowColor.value;
    }

    textContent.addEventListener('input', ()=>applyEditorTo(state.activeTextId));
    fontSize.addEventListener('input', ()=>applyEditorTo(state.activeTextId));
    fontColor.addEventListener('input', ()=>applyEditorTo(state.activeTextId));
    bold.addEventListener('change', ()=>applyEditorTo(state.activeTextId));
    italic.addEventListener('change', ()=>applyEditorTo(state.activeTextId));
    underline.addEventListener('change', ()=>applyEditorTo(state.activeTextId));
    align.addEventListener('change', ()=>applyEditorTo(state.activeTextId));
    fontFamily.addEventListener('change', ()=>applyEditorTo(state.activeTextId));
    shadowStrength.addEventListener('input', ()=>applyEditorTo(state.activeTextId));
    shadowBlur.addEventListener('input', ()=>applyEditorTo(state.activeTextId));
    shadowColor.addEventListener('input', ()=>applyEditorTo(state.activeTextId));

    // ---------- Drag (百分比定位) ----------
    for(const el of Object.values(texts)) makeDraggable(el,previewStage);

    function makeDraggable(el,boundary){
      normalizePercentPosition(el, boundary);

      let isDown=false; let startX=0,startY=0;
      let startLeftPx=0, startTopPx=0;

      const down=e=>{
        if (el.classList.contains('editing')) return;
        isDown=true;
        const p=getPoint(e);
        startX=p.x; startY=p.y;

        const brect=boundary.getBoundingClientRect();
        const {leftPercent, topPercent} = getInlineLeftTop(el, brect);
        startLeftPx = leftPercent * brect.width / 100;
        startTopPx  = topPercent  * brect.height/ 100;

        e.preventDefault();
        setActiveText(el.id);
      };

      const move=e=>{
        if(!isDown) return;
        if (el.classList.contains('editing')) return;
        const p=getPoint(e);
        const dx=p.x-startX, dy=p.y-startY;
        const brect=boundary.getBoundingClientRect();
        const rect=el.getBoundingClientRect();

        let leftPx = startLeftPx + dx;
        let topPx  = startTopPx  + dy;

        leftPx=Math.max(0,Math.min(leftPx,brect.width -rect.width));
        topPx =Math.max(0,Math.min(topPx ,brect.height-rect.height));

        const leftPercent = (leftPx / brect.width) * 100;
        const topPercent  = (topPx  / brect.height)* 100;

        el.style.left = `${leftPercent}%`;
        el.style.top  = `${topPercent}%`;

        el.dataset.leftPercent = leftPercent.toFixed(6);
        el.dataset.topPercent  = topPercent.toFixed(6);
      };

      const up=()=>{ isDown=false; };

      el.addEventListener('mousedown',down);
      window.addEventListener('mousemove',move);
      window.addEventListener('mouseup',up);
      el.addEventListener('touchstart',down,{passive:false});
      window.addEventListener('touchmove',move,{passive:false});
      window.addEventListener('touchend',up);
    }

    function normalizePercentPosition(el, boundary){
      const brect=boundary.getBoundingClientRect();
      let lp = parsePercent(el.style.left);
      let tp = parsePercent(el.style.top);

      if(Number.isNaN(lp) || Number.isNaN(tp)){
        const rect=el.getBoundingClientRect();
        const leftPx = rect.left - brect.left;
        const topPx  = rect.top  - brect.top;
        lp = (leftPx / brect.width) * 100;
        tp = (topPx  / brect.height)* 100;
      }

      el.style.left = `${lp}%`;
      el.style.top  = `${tp}%`;
      el.dataset.leftPercent = lp.toFixed(6);
      el.dataset.topPercent  = tp.toFixed(6);
    }

    function parsePercent(v){
      if(!v) return NaN;
      if(String(v).trim().endsWith('%')) return parseFloat(v);
      return NaN;
    }

    function getInlineLeftTop(el, brect){
      let lp = parsePercent(el.style.left);
      let tp = parsePercent(el.style.top);
      if(Number.isNaN(lp) || Number.isNaN(tp)){
        const rect=el.getBoundingClientRect();
        const leftPx = rect.left - brect.left;
        const topPx  = rect.top  - brect.top;
        lp = (leftPx / brect.width) * 100;
        tp = (topPx  / brect.height)* 100;
      }
      return { leftPercent: lp, topPercent: tp };
    }

    function clampPositionsToStage(){
      const brect=previewStage.getBoundingClientRect();
      for(const el of Object.values(texts)){
        const rect=el.getBoundingClientRect();

        let lp = parsePercent(el.style.left);
        let tp = parsePercent(el.style.top);
        if(Number.isNaN(lp) || Number.isNaN(tp)){
          const {leftPercent, topPercent} = getInlineLeftTop(el, brect);
          lp = leftPercent; tp = topPercent;
        }

        const maxLeftP = Math.max(0, (brect.width  - rect.width ) / brect.width  * 100);
        const maxTopP  = Math.max(0, (brect.height - rect.height) / brect.height * 100);

        lp = Math.min(Math.max(lp, 0), maxLeftP);
        tp = Math.min(Math.max(tp, 0), maxTopP);

        el.style.left = `${lp}%`;
        el.style.top  = `${tp}%`;
        el.dataset.leftPercent = lp.toFixed(6);
        el.dataset.topPercent  = tp.toFixed(6);
      }
    }

    function getPoint(e){ if(e.touches&&e.touches[0]) return {x:e.touches[0].clientX,y:e.touches[0].clientY}; return {x:e.clientX,y:e.clientY};}

    // ---------- Export ----------
    btnWebPng.addEventListener('click', ()=> withBusy(btnWebPng, async ()=>{
      status('Generating web preview PNG…');
      await ensureFontsReady();
      const dataUrl=await renderPreviewPNG();
      triggerDownload(dataUrl,`poster-web-${state.size}.png`);
      status('Done.');
    }));

    btnPrintPng.addEventListener('click', ()=> withBusy(btnPrintPng, async ()=>{
      status(`Rendering print PNG (${state.dpi} dpi)…`);
      await ensureFontsReady();
      const dataUrl=await renderPrintPNG();
      triggerDownload(dataUrl,`poster-print-${state.size}-${state.dpi}dpi.png`);
      status('Done.');
    }));

    btnPrintPdf.addEventListener('click', ()=> withBusy(btnPrintPdf, async ()=>{
      status(`Rendering print PDF (${state.dpi} dpi, true inches)…`);
      await ensureFontsReady();
      const canvas=await renderPrintCanvas();
      const { jsPDF }=window.jspdf;
      const wIn=state.inches.w, hIn=state.inches.h;
      const pdf=new jsPDF({orientation:wIn>hIn?'l':'p', unit:'in', format:[wIn,hIn]});
      const imgData=canvas.toDataURL('image/jpeg',1);
      pdf.addImage(imgData,'JPEG',0,0,wIn,hIn);
      pdf.save(`poster-print-${state.size}-${state.dpi}dpi.pdf`);
      status('Done.');
    }));

    // >>> 忽略辅助线元素，避免导出的 Web PNG 带线 <<<
    async function renderPreviewPNG(){
      lockScroll();
      try{
        const canvas=await html2canvas(previewStage,{
          allowTaint:false,
          useCORS:true,
          backgroundColor:'#ffffff',
          scale:1,
          ignoreElements: el => el.classList && el.classList.contains('guide')
        });
        return canvas.toDataURL('image/png');
      } finally { unlockScroll(); }
    }

    async function renderPrintPNG(){
      const canvas=await renderPrintCanvas();
      return canvas.toDataURL('image/png');
    }

    async function renderPrintCanvas(){
      const {w,h}=state.inches; let dpi=state.dpi;
      let W=Math.round(w*dpi), H=Math.round(h*dpi);

      if (shouldDownscale(W,H)) {
        dpi = Math.min(200, dpi);
        W = Math.round(w*dpi);
        H = Math.round(h*dpi);
        status(`Target too large → auto-downgraded to ${dpi} dpi (${W}×${H}px).`);
      }

      lockScroll();
      try{
        printStage.innerHTML=''; printStage.style.width=W+'px'; printStage.style.height=H+'px';

        const bgUrl=state.preview.bgLarge||state.preview.bgSmall;
        const wrap=document.createElement('div');
        wrap.style.cssText=`position:relative;width:${W}px;height:${H}px;overflow:visible;background:#ffffff;`;
        const img=document.createElement('img');
        img.style.cssText='position:absolute;inset:0;width:100%;height:100%;object-fit:cover;';
        img.crossOrigin='anonymous';
        img.src=bgUrl || '';
        wrap.appendChild(img);

        const pr=previewStage.getBoundingClientRect();
        const sx=W/pr.width, sy=H/pr.height;
        const k=(sx+sy)/2;

        await new Promise((res)=>{ if (!bgUrl) return res(); img.onload=res; img.onerror=res; });

        for(const id of ['t1','t2','t3']){
          const src=texts[id];
          const srec=src.getBoundingClientRect();
          const cs=getComputedStyle(src);

          const el=document.createElement('div');
          el.textContent=src.textContent;

          el.style.position='absolute';
          el.style.left=((srec.left-pr.left)*sx)+'px';
          el.style.top =((srec.top -pr.top )*sy)+'px';

          const fontPx=parseFloat(cs.fontSize)*k;
          el.style.fontSize=fontPx+'px';
          el.style.fontFamily=cs.fontFamily;
          el.style.color=cs.color;
          el.style.fontWeight=cs.fontWeight;
          el.style.fontStyle=cs.fontStyle;
          el.style.textDecoration=cs.textDecoration;
          el.style.textAlign=cs.textAlign;

          el.style.whiteSpace=cs.whiteSpace||'pre-wrap';
          el.style.lineHeight=(cs.lineHeight==='normal'?'1.15':cs.lineHeight);

          if(cs.letterSpacing && cs.letterSpacing.endsWith('px')){
            el.style.letterSpacing=(parseFloat(cs.letterSpacing)*k)+'px';
          }

          
          // Apply text shadow: prefer dataset parameters, fallback to parsing computed style
          let sds = parseInt(src.dataset.shadowS || '0', 10);
          let sblur = parseFloat(src.dataset.shadowBlur || '0');
          let scolor = src.dataset.shadowColor || '';
          if(!(sds>0) && cs.textShadow){
            const mm = (cs.textShadow||'').match(/(-?\d+(?:\.\d*)?)px\s+(-?\d+(?:\.\d*)?)px\s+(\d+(?:\.\d*)?)px\s+(rgba?\([^)]+\)|#[0-9a-fA-F]{3,8}|[a-zA-Z]+)/);
            if(mm){
              const ox = parseFloat(mm[1]);
              const oy = parseFloat(mm[2]);
              sds = Math.round(Math.hypot(ox, oy));
              sblur = parseFloat(mm[3]);
              scolor = mm[4];
            }
          }
          if(sds>0){
            const off = Math.max(1, Math.round(sds/10)) * k;
            const bl  = Math.max(0.5, sblur * k);
            el.style.textShadow = `${off}px ${off}px ${bl}px ${scolor || '#000'}`;
          } else {
            el.style.textShadow = 'none';
          }
el.style.display='inline-block';
          el.style.maxWidth='none';
          el.style.overflow='visible';

          wrap.appendChild(el);
        }

        printStage.appendChild(wrap);

        await (document.fonts && document.fonts.ready);
        const canvas=await html2canvas(wrap,{
          allowTaint:false,useCORS:true,backgroundColor:'#ffffff',scale:1,windowWidth:W,windowHeight:H,letterRendering:true
        });
        return canvas;
      } finally { unlockScroll(); }
    }

    function triggerDownload(dataUrl,filename){
      const a=document.createElement('a'); a.href=dataUrl; a.download=filename;
      document.body.appendChild(a); a.click(); a.remove();
    }

    function warnIfLocalTooSmall(nw,nh){
      if(state.preview.isLocal && (!nw||!nh)){
        const img=new Image();
        img.onload=()=>warnIfLocalTooSmall(img.naturalWidth,img.naturalHeight);
        img.src=state.preview.bgLarge||state.preview.bgSmall;
        return;
      }
      if(!nw||!nh) return;
      const needW=state.inches.w*state.dpi, needH=state.inches.h*state.dpi;
      if(nw<needW*0.98 || nh<needH*0.98){
        status(`Warning: local background may be too small for ${state.inches.w}×${state.inches.h} in @ ${state.dpi} dpi (need ~${needW}×${needH}px, got ${nw}×${nh}px). It will be upscaled.`);
      }
    }

    // ---------- First render ----------
    t1.style.fontFamily="'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif";
    t2.style.fontFamily="'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif";
    t3.style.fontFamily="'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif";

    normalizePercentPosition(t1, previewStage);
    normalizePercentPosition(t2, previewStage);
    normalizePercentPosition(t3, previewStage);

    attachClickToEdit(t1);
    attachClickToEdit(t2);
    attachClickToEdit(t3);

    setSize('24x30');
    setDpi(dpiSelect.value);
    applyPreviewBg();
    buildThumbs();
    setActiveText(state.activeTextId);
    status('Ready. Choose a background from the library or upload locally.');
    if(isMobileDevice()){
      status('On mobile: long-press text to edit; exporting 300 dpi can be heavy—200 dpi is recommended.');
    }

    // Reset 背景
    resetBg.addEventListener('click', ()=>{
      const v = state.size;
      state.preview.isLocal=false;
      state.preview.bgSmall=DEFAULT_BG[v].small;
      state.preview.bgLarge=DEFAULT_BG[v].large;
      state.activeThumbId=null;
      applyPreviewBg();
      buildThumbs();
      status('Background reset to default.');
    });
  </script>

  <!-- 浮动工具条 + 移动端 DPI 兜底等 -->
  <script>
  (function(){
    function isMobile(){ return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent); }
    function byId(id){ return document.getElementById(id); }
    function statusMsgEnh(msg){
      var el = byId('statusMsg');
      if(!el){
        el = document.createElement('div');
        el.id = 'statusMsg';
        el.setAttribute('role','status');
        el.setAttribute('aria-live','polite');
        el.textContent = 'Ready...';
        document.body.appendChild(el);
      }
      if(msg){ el.textContent = msg; }
    }

    function setMobileDefaultDpi(){
      try{
        if(!isMobile()) return;
        var dpiSel = document.querySelector('#dpiSelect, select[name="dpi"], select[data-dpi]');
        if(dpiSel){
          dpiSel.value = '200';
          var ev = new Event('change', {bubbles:true});
          dpiSel.dispatchEvent(ev);
        }
        if (typeof window.setDpi === 'function') {
          window.setDpi(200);
        }
        statusMsgEnh('On mobile: exporting 300 dpi can be heavy — 200 dpi is set by default.');
      }catch(e){ console.warn(e); }
    }

    function getEditableCandidates(){
      var sels = [
        '[data-editable]', '.editable', '.editable-text', '.text-layer', '.draggable-text',
        '[contenteditable="true"]', '[contenteditable="false"]', '[contenteditable]'
      ];
      var nodes = [];
      sels.forEach(function(s){
        document.querySelectorAll(s).forEach(function(n){ if(nodes.indexOf(n)===-1) nodes.push(n); });
      });
      if(nodes.length===0){
        var root = document.querySelector('#poster, #canvasRoot, .poster, main, .canvas-root') || document.body;
        root.querySelectorAll('h1,h2,h3,h4,p,span,div').forEach(function(n){
          if(n.childElementCount===0 && (n.textContent||'').trim().length>0){
            nodes.push(n);
          }
        });
      }
      return nodes;
    }

    function startInlineEdit(){
      if (typeof window.enterInlineEdit === 'function') {
        try{
          if(window.state && state.activeTextId && window.texts && texts[state.activeTextId]){
            return window.enterInlineEdit(texts[state.activeTextId]);
          }
        }catch(e){}
      }
      getEditableCandidates().forEach(function(n){
        n.setAttribute('contenteditable', 'true');
        n.classList.add('gp5-editing-highlight');
      });
      statusMsgEnh('Inline editing enabled. Tap text to edit, then click Finish to apply.');
    }
    function finishInlineEdit(){
      if (typeof window.exitInlineEdit === 'function') {
        try{
          if(window.state && state.activeTextId && window.texts && texts[state.activeTextId]){
            return window.exitInlineEdit(texts[state.activeTextId], true);
          }
        }catch(e){}
      }
      getEditableCandidates().forEach(function(n){
        if(n.classList.contains('gp5-editing-highlight')){
          n.removeAttribute('contenteditable');
          n.classList.remove('gp5-editing-highlight');
        }
      });
      statusMsgEnh('Inline editing finished.');
    }

    // >>> 修复：新窗口打开图片使用 Blob + 先开空白页，占住弹窗权限 <<<
    async function openImageInNewTab(){
      // 1) 先同步开空白页，避免被拦截
      const win = window.open('', '_blank');
      if(!win){ alert('Popup blocked. Please allow popups for this site.'); return; }
      win.document.write('<!doctype html><title>Preview</title><style>body{margin:0;font:14px system-ui} .msg{padding:16px;color:#334155}</style><div class="msg">Rendering…</div>');

      try{
        // 2) 选择一个可见根节点；若没有 exportRoot，就退回到 previewStage/main
        const root = document.querySelector('#exportRoot, #poster, #canvasRoot, .poster, #previewStage, main');
        if(!root) throw new Error('Export root not found');

        // 3) 渲染：用白底更稳（避免 iOS 空白）
        const canvas = await window.html2canvas(root, { useCORS:true, backgroundColor:'#ffffff', scale:1 });

        // 4) 用 Blob + blob:URL，而不是 dataURL
        const blob = await new Promise(res => canvas.toBlob(b => res(b), 'image/png', 1));
        if(!blob){
          // 极端兜底
          const fallback = canvas.toDataURL('image/png');
          win.location.href = fallback;
          win.document.title = 'Preview';
          return;
        }
        const url = URL.createObjectURL(blob);
        win.document.body.innerHTML = `<img src="${url}" style="display:block;max-width:100%;height:auto;margin:0 auto;" alt="preview">`;
        win.document.title = 'Preview';
        win.document.querySelector('img').onload = () => URL.revokeObjectURL(url);
      } catch (err){
        console.error(err);
        win.document.body.innerHTML = `<div class="msg">Failed to render image. Check CORS or try a smaller image / 200 DPI.</div>`;
      }
    }

    function ensureToolbar(){
      if(document.querySelector('.gp5-inline-toolbar')) return;
      var bar = document.createElement('div');
      bar.className = 'gp5-inline-toolbar';
      bar.innerHTML =
        '<button type="button" id="btnStartInline" title="Start inline edit">Start inline edit</button>' +
        '<button type="button" id="btnFinishInline" title="Finish inline edit">Finish</button>' +
        '<button type="button" id="btnOpenImageTab" title="Open exported image in a new tab">Open image in new tab</button>';
      document.body.appendChild(bar);
      document.getElementById('btnStartInline').addEventListener('click', startInlineEdit);
      document.getElementById('btnFinishInline').addEventListener('click', finishInlineEdit);
      document.getElementById('btnOpenImageTab').addEventListener('click', openImageInNewTab);
    }

    function ensureStatusRegion(){
      var el = byId('statusMsg');
      if(el){
        el.setAttribute('role','status');
        el.setAttribute('aria-live','polite');
      }else{
        statusMsgEnh('Ready...');
      }
    }

    document.addEventListener('DOMContentLoaded', function(){
      ensureStatusRegion();
      setMobileDefaultDpi();
      ensureToolbar();
    });
  })();
  </script>
</body>
</html>



