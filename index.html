<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>DIY Poster Creator – 24×30 / 24×50 in (Enhanced + Local Fonts)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- html2canvas & jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- ✅ Local Fonts preloads (place corresponding woff2 files under /fonts) -->
  <link rel="preload" href="/fonts/inter/inter-400.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/fonts/inter/inter-700.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/fonts/roboto/roboto-400.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/fonts/montserrat/montserrat-400.woff2" as="font" type="font/woff2" crossorigin>

  <style>
    /* ===================== Local Font Faces ===================== */
    @font-face { font-family: 'Inter'; src: url('/fonts/inter/inter-400.woff2') format('woff2'); font-weight: 400; font-style: normal; font-display: swap; }
    @font-face { font-family: 'Inter'; src: url('/fonts/inter/inter-700.woff2') format('woff2'); font-weight: 700; font-style: normal; font-display: swap; }

    @font-face { font-family: 'Roboto'; src: url('/fonts/roboto/roboto-400.woff2') format('woff2'); font-weight: 400; font-style: normal; font-display: swap; }
    @font-face { font-family: 'Open Sans'; src: url('/fonts/open-sans/opensans-400.woff2') format('woff2'); font-weight: 400; font-style: normal; font-display: swap; }
    @font-face { font-family: 'Montserrat'; src: url('/fonts/montserrat/montserrat-400.woff2') format('woff2'); font-weight: 400; font-style: normal; font-display: swap; }
    @font-face { font-family: 'Poppins'; src: url('/fonts/poppins/poppins-400.woff2') format('woff2'); font-weight: 400; font-style: normal; font-display: swap; }

    /* Handwriting (wedding etc.) */
    @font-face { font-family: 'Great Vibes'; src: url('/fonts/handwriting/great-vibes-400.woff2') format('woff2'); font-weight: 400; font-style: normal; font-display: swap; }
    @font-face { font-family: 'Dancing Script'; src: url('/fonts/handwriting/dancing-script-700.woff2') format('woff2'); font-weight: 700; font-style: normal; font-display: swap; }
    @font-face { font-family: 'Pacifico'; src: url('/fonts/handwriting/pacifico-400.woff2') format('woff2'); font-weight: 400; font-style: normal; font-display: swap; }
    @font-face { font-family: 'Caveat'; src: url('/fonts/handwriting/caveat-700.woff2') format('woff2'); font-weight: 700; font-style: normal; font-display: swap; }

    /* ===================== App Styles ===================== */
    .draggable{ position:absolute; cursor:move; user-select:none; touch-action:none; white-space:pre-wrap; line-height:1.15; transition: box-shadow .15s ease, outline-color .15s ease, outline-offset .15s ease; }
    .draggable.active{ outline:2px dashed #6366f1; outline-offset:2px; }
    .draggable.editing{ cursor:text; outline:2px solid #6366f1; outline-offset:2px; box-shadow: 0 0 0 4px rgba(99,102,241,.15); }

    #previewStage{ width:100%; max-width:960px; margin:0 auto; aspect-ratio:4/5; position:relative; background:#fff; border:1px dashed #cbd5e1; overflow:hidden; }
    #previewBgWrap{ position:absolute; inset:0; overflow:hidden; background:#f3f4f6; }
    #previewBgImg{ width:100%; height:100%; object-fit:cover; display:block; }

    .guide-center{ position:absolute; left:0; right:0; top:50%; height:1px; background:rgba(0,0,0,.08); }
    .guide-center.v{ top:0; bottom:0; left:50%; width:1px; height:auto; }
    .guide-trim, .guide-safe, .guide-bleed{ position:absolute; pointer-events:none; }
    .guide-trim  { outline:2px dashed rgba(239,68,68,.9); }
    .guide-safe  { outline:2px dashed rgba(34,197,94,.9); }
    .guide-bleed { outline:2px dashed rgba(59,130,246,.9); }

    .export-ignore{ }
    #printStage{ position:fixed; left:-99999px; top:-99999px; background:#fff; overflow:hidden; }

    :root{ --ab-h: 88px; }
    @media (min-width:1024px){ :root{ --ab-h: 0px; } }

    /* ✅ FIX: make status message inline so it never blocks footer buttons */
    #statusMsg{
      position: static; /* was fixed */
      background: transparent; /* remove dark bubble */
      color: #64748b;
      padding: 0;
      border-radius: 0;
      font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      pointer-events: none; /* never intercept taps */
      z-index: 10; /* below footer */
    }

    footer { border-top:1px solid #e2e8f0; background:#fff; font-size:12px; color:#64748b; }
    footer a { color:#0ea5e9; text-decoration:none; }
    footer a:hover { text-decoration:underline; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- ✅ iOS Download Notice (shown only on iOS, can be closed) -->
  <div id="iosNotice" class="hidden bg-yellow-50 text-yellow-900 text-sm px-4 py-2">
    Notice: Detected iOS device. If the downloaded print file fails or appears blank, please try setting DPI to 200, or <b>use a computer</b> to export again.
    <button id="closeIosNotice" class="float-right text-yellow-800 hover:underline">Close</button>
  </div>

  <!-- Header -->
  <header class="border-b bg-white sticky top-0 z-30">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <h1 class="text-lg md:text-xl font-semibold">DIY Poster Creator</h1>
      <div class="flex items-center gap-2 text-sm">
        <span class="px-2 py-1 rounded bg-slate-100">24×30 / 24×50 in</span>
        <span class="hidden md:inline text-slate-500">Preview 1920px • Print 300/200 dpi</span>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-4">
    <!-- Preview -->
    <section class="lg:col-span-8">
      <div id="tipBar" class="mb-3 text-xs md:text-sm p-2 rounded border bg-blue-50 text-blue-800">
        Click a text to select; <b>double-click</b> (desktop) or <b>long-press 0.6s</b> (mobile) to edit inline.
        Press <kbd>Esc</kbd> or tap outside to finish. Export at <b>300 dpi</b> (auto-fall back to <b>200 dpi</b> if too large).
        <span class="ml-1 text-yellow-700"><b>Note for iOS:</b> If export fails, set 200 dpi or <b>use a computer</b>.</span>
      </div>

      <div id="previewStage" class="rounded-lg shadow-sm bg-white">
        <div id="previewBgWrap"><img id="previewBgImg" alt="background"></div>

        <!-- Center guides -->
        <div class="guide-center hidden export-ignore" id="guideH"></div>
        <div class="guide-center v hidden export-ignore" id="guideV"></div>

        <!-- Bleed / Trim / Safe Area (preview overlays) -->
        <div id="bleedGuide" class="guide-bleed hidden export-ignore" aria-hidden="true"></div>
        <div id="trimGuide"  class="guide-trim  hidden export-ignore" aria-hidden="true"></div>
        <div id="safeGuide"  class="guide-safe  hidden export-ignore" aria-hidden="true"></div>

        <!-- Draggable texts -->
        <div id="t1" class="draggable text-3xl font-bold" style="left:50%; top:20%; transform:translateX(-50%); text-align:center;">MAIN TITLE</div>
        <div id="t2" class="draggable text-xl" style="left:50%; top:35%; transform:translateX(-50%); text-align:center;">Subtitle goes here</div>
        <div id="t3" class="draggable text-base" style="left:50%; top:50%; transform:translateX(-50%); text-align:center;">Description or notes</div>
      </div>

      <div class="mt-3 text-xs md:text-sm text-slate-600" id="specInfo"></div>
    </section>

    <!-- Controls -->
    <aside class="lg:col-span-4">
      <div class="bg-white rounded-xl shadow p-4 space-y-4">
        <!-- Size -->
        <div>
          <label class="block text-sm font-medium mb-1">Poster Size (inches)</label>
          <select id="sizeSelect" class="w-full border rounded px-3 py-2">
            <option value="24x30">24 × 30 in (preview 1920×2400)</option>
            <option value="24x50">24 × 50 in (preview 1920×4000)</option>
          </select>
        </div>

        <!-- DPI + Center Guides -->
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-sm font-medium mb-1">Print DPI</label>
            <select id="dpiSelect" class="w-full border rounded px-3 py-2">
              <option value="300" selected>300 dpi (print-ready)</option>
              <option value="200">200 dpi (lighter)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Center Guides</label>
            <select id="guideSelect" class="w-full border rounded px-3 py-2">
              <option value="off" selected>Off</option>
              <option value="on">Show center guides</option>
            </select>
          </div>
        </div>

        <!-- Background picker -->
        <div class="space-y-2">
          <div class="flex items-center justify-between gap-2">
            <label class="text-sm font-medium">Background</label>
            <div class="flex items-center gap-2">
              <input type="file" id="bgUpload" accept="image/*" class="block w-[180px] text-xs" />
              <button id="resetBg" class="text-xs px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">Reset</button>
            </div>
          </div>

          <div class="space-y-2">
            <div id="thumbGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2 rounded border bg-slate-50 p-2"></div>
            <div class="flex items-center justify-between">
              <div class="text-xs text-slate-500" id="pageInfo">Page 1 / 1</div>
              <div class="flex items-center gap-1">
                <button id="pageFirst" class="px-2 py-1 text-xs rounded bg-slate-100 hover:bg-slate-200">« First</button>
                <button id="pagePrev"  class="px-2 py-1 text-xs rounded bg-slate-100 hover:bg-slate-200">‹ Prev</button>
                <button id="pageNext"  class="px-2 py-1 text-xs rounded bg-slate-100 hover:bg-slate-200">Next ›</button>
                <button id="pageLast"  class="px-2 py-1 text-xs rounded bg-slate-100 hover:bg-slate-200">Last »</button>
              </div>
            </div>
          </div>

          <p class="text-xs text-slate-500">
            Tip: Thumbnails are lazy-loaded. Print uses original at 300/200 dpi. Local uploads are embedded.
          </p>
        </div>
        
<!-- ==================== 插入这里：布局模板按钮区 START ==================== -->
        <div class="space-y-1">
          <label class="block text-sm font-medium mb-1">Text Layout Template</label>
          <div class="flex flex-wrap gap-2 text-xs">
              <button class="px-2 py-1 rounded bg-slate-100 hover:bg-slate-200" onclick="applyLayout('centered')">Centered</button>
              <button class="px-2 py-1 rounded bg-slate-100 hover:bg-slate-200" onclick="applyLayout('topLeft')">Top Left</button>
              <button class="px-2 py-1 rounded bg-slate-100 hover:bg-slate-200" onclick="applyLayout('bottomRight')">Bottom Right</button>
            </div>
          </div>
<!-- ==================== 插入这里：布局模板按钮区 END ==================== -->

        <!-- Text editor -->
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <span class="text-sm font-medium">Edit Text</span>
            <div class="text-xs space-x-1">
              <button data-target="t1" class="pickTarget px-2 py-1 rounded bg-slate-100">Text 1</button>
              <button data-target="t2" class="pickTarget px-2 py-1 rounded bg-slate-100">Text 2</button>
              <button data-target="t3" class="pickTarget px-2 py-1 rounded bg-slate-100">Text 3</button>
            </div>
          </div>

          <textarea id="textContent" rows="3" class="w-full border rounded px-3 py-2 text-sm" placeholder="Type here…"></textarea>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-xs mb-1">Font size (px)</label>
              <input type="number" id="fontSize" class="w-full border rounded px-2 py-1 text-sm" value="36" min="8" max="300" />
            </div>
            <div>
              <label class="block text-xs mb-1">Color</label>
              <input type="color" id="fontColor" class="w-full h-[36px] border rounded" value="#111827" />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-xs mb-1">Font family</label>
              <select id="fontFamily" class="w-full border rounded px-2 py-1 text-sm">
                <option value="'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif">Inter (Sans)</option>
                <option value="'Roboto', system-ui, -apple-system, Segoe UI, Arial, sans-serif">Roboto (Sans)</option>
                <option value="'Open Sans', system-ui, -apple-system, Segoe UI, Arial, sans-serif">Open Sans (Sans)</option>
                <option value="'Lato', system-ui, -apple-system, Segoe UI, Arial, sans-serif">Lato (Sans)</option>
                <option value="'Montserrat', system-ui, -apple-system, Segoe UI, Arial, sans-serif">Montserrat (Sans)</option>
                <option value="'Poppins', system-ui, -apple-system, Segoe UI, Arial, sans-serif">Poppins (Sans)</option>
                <option value="'Nunito', system-ui, -apple-system, Segoe UI, Arial, sans-serif">Nunito (Sans)</option>
                <option value="'Source Sans 3', system-ui, -apple-system, Segoe UI, Arial, sans-serif">Source Sans 3 (Sans)</option>
                <option value="'Ubuntu', system-ui, -apple-system, Segoe UI, Arial, sans-serif">Ubuntu (Sans)</option>
                <option value="'Noto Sans', system-ui, -apple-system, Segoe UI, Arial, sans-serif">Noto Sans (Sans)</option>
                <option value="'Caveat', 'Comic Sans MS', cursive">Caveat (Handwriting)</option>
                <option value="'Pacifico', 'Comic Sans MS', cursive">Pacifico (Handwriting)</option>
                <option value="'Dancing Script', 'Comic Sans MS', cursive">Dancing Script (Handwriting)</option>
                <option value="'Great Vibes', 'Comic Sans MS', cursive">Great Vibes (Handwriting)</option>
              </select>
            </div>
            <div class="flex flex-wrap items-center gap-2 text-xs">
              <label class="inline-flex items-center gap-1 mt-6"><input type="checkbox" id="bold"> Bold</label>
              <label class="inline-flex items-center gap-1 mt-6"><input type="checkbox" id="italic"> Italic</label>
              <label class="inline-flex items-center gap-1 mt-6"><input type="checkbox" id="underline"> Underline</label>
              <select id="align" class="border rounded px-2 py-1 mt-5">
                <option value="left">Left</option>
                <option value="center">Center</option>
                <option value="right">Right</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-3 gap-2">
            <div>
              <label class="block text-xs mb-1">Shadow strength</label>
              <input type="range" id="shadowStrength" min="0" max="100" value="35" />
            </div>
            <div>
              <label class="block text-xs mb-1">Shadow blur</label>
              <input type="range" id="shadowBlur" min="0" max="30" value="10" />
            </div>
            <div>
              <label class="block text-xs mb-1">Shadow color</label>
              <input type="color" id="shadowColor" value="#000000" class="w-full h-[36px] border rounded" />
            </div>
          </div>
        </div>

        <!-- Print-shop helpers -->
        <div class="space-y-3 border-t pt-3">
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-sm font-medium mb-1">Safe Margin (in)</label>
              <input type="number" id="safeIn" step="0.0625" value="0.25" class="w-full border rounded px-2 py-1" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Bleed (in)</label>
              <input type="number" id="bleedIn" step="0.0625" value="0.125" class="w-full border rounded px-2 py-1" />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" id="showGuides" />
              <span class="text-sm">Show Trim/Safe/Bleed guides (preview)</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" id="includeGuidesPdf" />
              <span class="text-sm">Include guides in PDF export</span>
            </label>
          </div>

          <p class="text-xs text-slate-500">
            Print tips: common shops (FedEx/Staples) prefer 0.125–0.25 in bleed, 0.25–0.5 in safe margin. Use 200 dpi for very long posters on mobile.
          </p>
        </div>
      </div>
    </aside>
  </main>

  <!-- Footer (actions) -->
  <footer class="fixed bottom-0 left-0 right-0 border-t bg-white/95 backdrop-blur z-50" id="actionBar">
    <div class="max-w-6xl mx-auto px-4 py-3 flex flex-col md:flex-row items-center justify-between gap-3">
      <div class="flex items-center gap-2 text-xs md:text-sm">
        <span class="text-slate-600" id="statusMsg">Ready.</span>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <button id="btnSave"  class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm">Save Design</button>
        <button id="btnLoad"  class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm">Load Design</button>
        <button id="btnClear" class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm">Clear Saved</button>

        <span class="hidden md:inline w-px h-6 bg-slate-200 mx-1"></span>

        <button id="btnWebPng"  class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm">Download Web PNG (1920px)</button>
        <button id="btnPrintPng" class="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-sm">Download Print PNG (DPI)</button>
        <button id="btnPrintPdf" class="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm">Download Print PDF (true inches)</button>
      </div>
    </div>
  </footer>

  <!-- ✅ License footer -->
  <div class="text-center py-3" style="border-top:1px solid #e2e8f0;background:#fff;">
    <p class="text-xs text-slate-500">
      Fonts by <a href="https://fonts.google.com/" target="_blank" rel="noopener noreferrer">Google Fonts</a>
      (<a href="https://scripts.sil.org/OFL" target="_blank" rel="noopener noreferrer">Open Font License</a>)
    </p>
  </div>

  <div id="printStage"></div>

  <script>
  // ===================== State & Elements =====================
  const DEFAULT_BG = {
    '24x30': {
      small: 'https://kvw51688-max.github.io/v/24-30-1.webp',
      large: 'https://kvw51688-max.github.io/v/24-30-1.png'
    },
    '24x50': {
      small: 'https://kvw51688-max.github.io/v/24-50-1.webp',
      large: 'https://kvw51688-max.github.io/v/24-50-1.png'
    }
  };
  const ASSET_LIBRARY = [
    { id:'lib-2430-1', label:'24×30 – BG #1', size:'24x30',
      small:'https://kvw51688-max.github.io/v/24-30-1.webp',
      large:'https://kvw51688-max.github.io/v/24-30-1.png',
      naturalW: 3600, naturalH: 4500 },
    { id:'lib-2450-1', label:'24×50 – BG #1', size:'24x50',
      small:'https://kvw51688-max.github.io/v/24-50-1.webp',
      large:'https://kvw51688-max.github.io/v/24-50-1.png',
      naturalW: 4800, naturalH: 10000 }
  ];
  const PAGE_SIZE = 12;

  const state = {
    size:'24x30',
    dpi:300,
    inches:{w:24, h:30},
    preview:{ width:1920, height:2400, bgSmall:null, bgLarge:null, isLocal:false, naturalW:null, naturalH:null },
    picks: { '24x30': null, '24x50': null },
    pageIndex: { '24x30': 0, '24x50': 0 },
    activeTextId:'t1',
    inlineEditing:null
  };

  const previewStage = document.getElementById('previewStage');
  const previewBgImg = document.getElementById('previewBgImg');
  const printStage   = document.getElementById('printStage');
  const guideH = document.getElementById('guideH');
  const guideV = document.getElementById('guideV');
  const trimGuide = document.getElementById('trimGuide');
  const safeGuide = document.getElementById('safeGuide');
  const bleedGuide= document.getElementById('bleedGuide');

  const sizeSelect = document.getElementById('sizeSelect');
  const dpiSelect  = document.getElementById('dpiSelect');
  const guideSelect= document.getElementById('guideSelect');
  const specInfo   = document.getElementById('specInfo');
  const statusMsg  = document.getElementById('statusMsg');

  const bgUpload = document.getElementById('bgUpload');
  const resetBg  = document.getElementById('resetBg');
  const thumbGrid= document.getElementById('thumbGrid');
  const pageInfo = document.getElementById('pageInfo');
  const pageFirst= document.getElementById('pageFirst');
  const pagePrev = document.getElementById('pagePrev');
  const pageNext = document.getElementById('pageNext');
  const pageLast = document.getElementById('pageLast');

  const showGuides = document.getElementById('showGuides');
  const includeGuidesPdf = document.getElementById('includeGuidesPdf');
  const safeIn = document.getElementById('safeIn');
  const bleedIn= document.getElementById('bleedIn');

  const btnWebPng = document.getElementById('btnWebPng');
  const btnPrintPng = document.getElementById('btnPrintPng');
  const btnPrintPdf = document.getElementById('btnPrintPdf');

  const btnSave = document.getElementById('btnSave');
  const btnLoad = document.getElementById('btnLoad');
  const btnClear= document.getElementById('btnClear');

  const t1=document.getElementById('t1');
  const t2=document.getElementById('t2');
  const t3=document.getElementById('t3');
  const texts={t1,t2,t3};

  const iosNotice = document.getElementById('iosNotice');
  const closeIosNotice = document.getElementById('closeIosNotice');

  // ===================== Utilities =====================
  function status(msg){ statusMsg.textContent=msg; }
  function parsePercent(v){ if(!v) return NaN; if(String(v).trim().endsWith('%')) return parseFloat(v); return NaN; }
  function isMobile(){ return /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent); }
  function isIOS(){ return /iP(hone|ad|od)/i.test(navigator.userAgent); }
  function lockScroll(){ document.body.style.overflow='hidden'; }
  function unlockScroll(){ document.body.style.overflow=''; }
  function rgbToHex(rgb){ const m=rgb.match(/\d+/g); if(!m) return '#000000'; const [r,g,b]=m.map(Number); return '#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join(''); }
  async function ensureFontsReady(){ if (document.fonts && document.fonts.ready) { try { await document.fonts.ready; } catch(_){} } }

  // iOS top notice
  (function(){
    if(isIOS()){
      iosNotice.classList.remove('hidden');
      closeIosNotice.addEventListener('click', ()=> iosNotice.classList.add('hidden'));
    }
  })();

  // ===================== Size / DPI =====================
  function setSize(v){
    state.picks[state.size] = {
      small: state.preview.bgSmall, large: state.preview.bgLarge, isLocal: state.preview.isLocal,
      naturalW: state.preview.naturalW, naturalH: state.preview.naturalH
    };
    state.size=v;
    if(v==='24x30'){ state.preview.height=2400; state.inches={w:24,h:30}; previewStage.style.aspectRatio='4/5'; }
    else           { state.preview.height=4000; state.inches={w:24,h:50}; previewStage.style.aspectRatio='24/50'; }

    if(isIOS() && v==='24x50'){ dpiSelect.value='200'; setDpi(200); status('On iPhone: 200 DPI set for stability.'); }

    const pick = state.picks[v];
    if (pick && pick.small && pick.large){
      Object.assign(state.preview, { bgSmall:pick.small, bgLarge:pick.large, isLocal:!!pick.isLocal, naturalW:pick.naturalW||null, naturalH:pick.naturalH||null });
    } else {
      Object.assign(state.preview, { bgSmall: DEFAULT_BG[v].small, bgLarge: DEFAULT_BG[v].large, isLocal:false, naturalW:null, naturalH:null });
    }
    applyPreviewBg();
    updateSpecInfo();
    buildThumbs();
    clampPositionsToStage();
    layoutGuides();
  }
  function setDpi(v){ state.dpi=parseInt(v,10); updateSpecInfo(); }

  function updateSpecInfo(){
    const {w,h}=state.inches;
    const printWpx=Math.round(w*state.dpi), printHpx=Math.round(h*state.dpi);
    specInfo.innerHTML = `<b>Spec:</b> Print ${w}×${h} in @ ${state.dpi} dpi → <b>${printWpx}×${printHpx} px</b>`;
  }

  // ===================== Preview BG =====================
  function applyPreviewBg(){
    previewBgImg.crossOrigin = 'anonymous';
    previewBgImg.src = state.preview.bgSmall || DEFAULT_BG[state.size].small;
    previewBgImg.onload = ()=>{
      if(!state.preview.naturalW || !state.preview.naturalH){
        state.preview.naturalW = previewBgImg.naturalWidth;
        state.preview.naturalH = previewBgImg.naturalHeight;
      }
    };
  }

  // ===================== Thumbs / Library =====================
  function getAllItemsForSize(size){ return ASSET_LIBRARY.filter(i=>i.size===size); }
  function buildThumbs(){
    thumbGrid.innerHTML='';
    const size = state.size;
    const all = getAllItemsForSize(size);
    const total = all.length || 1;
    const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    const page = Math.min(Math.max(0, state.pageIndex[size] || 0), totalPages - 1);
    state.pageIndex[size] = page;

    const start = page * PAGE_SIZE;
    const end = Math.min(total, start + PAGE_SIZE);
    const pageItems = all.slice(start, end);

    pageItems.forEach(item=>{
      const btn = document.createElement('button');
      btn.type='button';
      btn.className='relative border-2 border-transparent rounded-lg overflow-hidden bg-slate-200 aspect-[3/2]';
      btn.title = item.label || 'Background';
      btn.dataset.small = item.small;
      btn.dataset.large = item.large || item.small;
      btn.dataset.nw = item.naturalW||'';
      btn.dataset.nh = item.naturalH||'';
      btn.innerHTML = `<img alt="${item.label||'bg'}" loading="lazy" class="w-full h-full object-cover" src="${item.small}">`;
      btn.addEventListener('click',()=>{
        state.preview.isLocal=false;
        state.preview.bgSmall=item.small;
        state.preview.bgLarge=item.large||item.small;
        state.preview.naturalW=parseInt(btn.dataset.nw||'0',10)||null;
        state.preview.naturalH=parseInt(btn.dataset.nh||'0',10)||null;
        applyPreviewBg();
        status('Background set from library.');
      });
      thumbGrid.appendChild(btn);
    });

    pageInfo.textContent = `Page ${page+1} / ${totalPages}`;
    pageFirst.disabled = (page === 0);
    pagePrev.disabled  = (page === 0);
    pageNext.disabled  = (page >= totalPages-1);
    pageLast.disabled  = (page >= totalPages-1);
  }
  pageFirst.addEventListener('click', ()=>{ state.pageIndex[state.size]=0; buildThumbs(); });
  pagePrev .addEventListener('click', ()=>{ state.pageIndex[state.size]=Math.max(0,(state.pageIndex[state.size]||0)-1); buildThumbs(); });
  pageNext .addEventListener('click', ()=>{
    const all = getAllItemsForSize(state.size);
    const totalPages = Math.max(1, Math.ceil(all.length / PAGE_SIZE));
    state.pageIndex[state.size]=Math.min(totalPages-1,(state.pageIndex[state.size]||0)+1); buildThumbs();
  });
  pageLast .addEventListener('click', ()=>{
    const all = getAllItemsForSize(state.size);
    const totalPages = Math.max(1, Math.ceil(all.length / PAGE_SIZE));
    state.pageIndex[state.size]=totalPages-1; buildThumbs();
  });

  // ===================== Local upload =====================
  bgUpload.addEventListener('change', async(e)=>{
    const file=e.target.files?.[0]; if(!file) return;
    const dataUrl=await readFileAsDataURL(file);
    const img=new Image();
    img.onload=()=>{
      state.preview.isLocal=true;
      state.preview.bgSmall=dataUrl;
      state.preview.bgLarge=dataUrl;
      state.preview.naturalW=img.naturalWidth;
      state.preview.naturalH=img.naturalHeight;
      applyPreviewBg();
      status(`Local background loaded: ${img.naturalWidth}×${img.naturalHeight}`);
      e.target.value='';
    };
    img.src=dataUrl;
  });
  function readFileAsDataURL(file){
    return new Promise((resolve,reject)=>{
      const fr=new FileReader();
      fr.onload=()=>resolve(fr.result); fr.onerror=reject; fr.readAsDataURL(file);
    });
  }
  resetBg.addEventListener('click', ()=>{
    const v = state.size;
    Object.assign(state.preview, { isLocal:false, bgSmall:DEFAULT_BG[v].small, bgLarge:DEFAULT_BG[v].large, naturalW:null, naturalH:null });
    applyPreviewBg();
    status('Background reset to default.');
  });

    // ==================== 插入这里：布局模板逻辑 START ====================
// 预设三种布局模板
const layoutTemplates = {
  centered: [
    { id:'t1', left:'50%', top:'20%', align:'center' },
    { id:'t2', left:'50%', top:'35%', align:'center' },
    { id:'t3', left:'50%', top:'50%', align:'center' },
  ],
  topLeft: [
    { id:'t1', left:'10%', top:'10%', align:'left' },
    { id:'t2', left:'10%', top:'25%', align:'left' },
    { id:'t3', left:'10%', top:'40%', align:'left' },
  ],
  bottomRight: [
    { id:'t1', left:'60%', top:'65%', align:'right' },
    { id:'t2', left:'60%', top:'75%', align:'right' },
    { id:'t3', left:'60%', top:'85%', align:'right' },
  ]
};

// 一键应用模板函数
function applyLayout(name){
  const tpl = layoutTemplates[name];
  if(!tpl) return;
  tpl.forEach(t=>{
    const el = document.getElementById(t.id);
    el.style.left = t.left;
    el.style.top = t.top;
    el.style.textAlign = t.align;
    el.style.transform = (t.align === 'center') ? 'translateX(-50%)' : 'none';
  });
  status(`Applied layout: ${name}`);
}
// ==================== 插入这里：布局模板逻辑 END ====================

  // ===================== Text Editing =====================
  function setActiveText(id){
    state.activeTextId = id;
    for (const el of Object.values(texts)) el.classList.remove('active');
    texts[id]?.classList.add('active');
    loadTextEditorFrom(id);
  }
  function rgbToStyleHex(c){ if(!c) return '#000000'; if(c.startsWith('#')) return c; return rgbToHex(getComputedStyle(Object.assign(document.createElement('div'),{style:{color:c}})).color); }
  function loadTextEditorFrom(id){
    const el=texts[id]; if(!el) return;
    for (const n of Object.values(texts)) n.classList.remove('active');
    el.classList.add('active');
    textContent.value=el.innerText;
    const cs=getComputedStyle(el);
    fontSize.value=parseInt(cs.fontSize,10)||36;
    fontColor.value=rgbToStyleHex(cs.color);
    const fam=cs.fontFamily;
    const opts=Array.from(fontFamily.options);
    const found=opts.find(o=>fam.toLowerCase().includes(o.value.split(',')[0].replace(/["']/g,'').toLowerCase()));
    if(found) fontFamily.value=found.value;
    bold.checked=cs.fontWeight==='700'||parseInt(cs.fontWeight,10)>=600;
    italic.checked=cs.fontStyle==='italic';
    underline.checked=(cs.textDecorationLine||'').includes('underline');
    align.value=cs.textAlign||'left';
    const dsS = parseInt(el.dataset.shadowS||'',10);
    const dsB = parseFloat(el.dataset.shadowBlur||'');
    if(!Number.isNaN(dsS)) shadowStrength.value = dsS;
    if(!Number.isNaN(dsB)) shadowBlur.value = dsB;
    shadowColor.value = el.dataset.shadowColor || '#000000';
  }
  function applyEditorTo(id){
    const el=texts[id]; if(!el) return;
    el.innerText=textContent.value;
    el.style.fontSize=`${parseInt(fontSize.value,10)}px`;
    el.style.color=fontColor.value;
    el.style.fontWeight=bold.checked?'700':'400';
    el.style.fontStyle=italic.checked?'italic':'normal';
    el.style.textDecoration=underline.checked?'underline':'none';
    el.style.textAlign=align.value;
    el.style.fontFamily=fontFamily.value;
    const s=parseInt(shadowStrength.value,10)||0;
    const bl=parseInt(shadowBlur.value,10)||0;
    const off=Math.round(s/10)||0;
    el.style.textShadow = s===0 ? 'none' : `${off}px ${off}px ${bl}px ${shadowColor.value}`;
    el.dataset.shadowS=String(s);
    el.dataset.shadowBlur=String(bl);
    el.dataset.shadowColor=shadowColor.value;
  }
  textContent.addEventListener('input', ()=>applyEditorTo(state.activeTextId));
  fontSize.addEventListener('input', ()=>applyEditorTo(state.activeTextId));
  fontColor.addEventListener('input', ()=>applyEditorTo(state.activeTextId));
  bold.addEventListener('change', ()=>applyEditorTo(state.activeTextId));
  italic.addEventListener('change', ()=>applyEditorTo(state.activeTextId));
  underline.addEventListener('change', ()=>applyEditorTo(state.activeTextId));
  align.addEventListener('change', ()=>applyEditorTo(state.activeTextId));
  fontFamily.addEventListener('change', ()=>applyEditorTo(state.activeTextId));
  shadowStrength.addEventListener('input', ()=>applyEditorTo(state.activeTextId));
  shadowBlur.addEventListener('input', ()=>applyEditorTo(state.activeTextId));
  shadowColor.addEventListener('input', ()=>applyEditorTo(state.activeTextId));

  for(const el of Object.values(texts)) makeDraggable(el,previewStage);
  function makeDraggable(el,boundary){
    normalizePercentPosition(el,boundary);
    let isDown=false, startX=0,startY=0, startLeftPx=0, startTopPx=0;
    const down=e=>{
      if (el.classList.contains('editing')) return;
      isDown=true; const p=getPoint(e); startX=p.x; startY=p.y;
      const b=boundary.getBoundingClientRect(); const {leftPercent, topPercent} = getInlineLeftTop(el, b);
      startLeftPx = leftPercent * b.width / 100;
      startTopPx  = topPercent  * b.height/ 100;
      e.preventDefault(); setActiveText(el.id);
    };
    const move=e=>{
      if(!isDown || el.classList.contains('editing')) return;
      const p=getPoint(e); const dx=p.x-startX, dy=p.y-startY;
      const b=boundary.getBoundingClientRect(); const r=el.getBoundingClientRect();
      let leftPx = startLeftPx + dx; let topPx = startTopPx + dy;
      leftPx=Math.max(0,Math.min(leftPx,b.width -r.width));
      topPx =Math.max(0,Math.min(topPx ,b.height-r.height));
      const leftPercent = (leftPx / b.width) * 100;
      const topPercent  = (topPx  / b.height)* 100;
      el.style.left = `${leftPercent}%`; el.style.top = `${topPercent}%`;
      el.dataset.leftPercent = leftPercent.toFixed(6);
      el.dataset.topPercent  = topPercent.toFixed(6);
    };
    const up=()=>{ isDown=false; };
    el.addEventListener('mousedown',down);
    window.addEventListener('mousemove',move);
    window.addEventListener('mouseup',up);
    el.addEventListener('touchstart',down,{passive:false});
    window.addEventListener('touchmove',move,{passive:false});
    window.addEventListener('touchend',up);
  }
  function getPoint(e){ if(e.touches&&e.touches[0]) return {x:e.touches[0].clientX,y:e.touches[0].clientY}; return {x:e.clientX,y:e.clientY};}
  function normalizePercentPosition(el, boundary){
    const b=boundary.getBoundingClientRect();
    let lp = parsePercent(el.style.left), tp = parsePercent(el.style.top);
    if(Number.isNaN(lp) || Number.isNaN(tp)){
      const r=el.getBoundingClientRect();
      lp = ((r.left - b.left)/b.width) * 100;
      tp = ((r.top  - b.top )/b.height)* 100;
    }
    el.style.left = `${lp}%`; el.style.top = `${tp}%`;
    el.dataset.leftPercent = lp.toFixed(6); el.dataset.topPercent = tp.toFixed(6);
  }
  function getInlineLeftTop(el, brect){
    let lp = parsePercent(el.style.left), tp = parsePercent(el.style.top);
    if(Number.isNaN(lp) || Number.isNaN(tp)){
      const r=el.getBoundingClientRect();
      lp = ( (r.left - brect.left) / brect.width ) * 100;
      tp = ( (r.top  - brect.top ) / brect.height) * 100;
    }
    return { leftPercent: lp, topPercent: tp };
  }
  function clampPositionsToStage(){
    const b=previewStage.getBoundingClientRect();
    for(const el of Object.values(texts)){
      const r=el.getBoundingClientRect();
      let lp = parsePercent(el.style.left), tp = parsePercent(el.style.top);
      if(Number.isNaN(lp) || Number.isNaN(tp)){
        const p=getInlineLeftTop(el, b); lp=p.leftPercent; tp=p.topPercent;
      }
      const maxLeftP = Math.max(0, (b.width  - r.width ) / b.width  * 100);
      const maxTopP  = Math.max(0, (b.height - r.height) / b.height * 100);
      lp = Math.min(Math.max(lp, 0), maxLeftP);
      tp = Math.min(Math.max(tp, 0), maxTopP);
      el.style.left = `${lp}%`; el.style.top  = `${tp}%`;
      el.dataset.leftPercent = lp.toFixed(6); el.dataset.topPercent = tp.toFixed(6);
    }
  }

  // ===================== Guides (bleed/trim/safe) =====================
  function layoutGuides(){
    const {w}=state.inches;
    const pxPerInPreview = previewStage.clientWidth / w;
    const bleed = Math.max(0, parseFloat(bleedIn.value)||0);
    const safe  = Math.max(0, parseFloat(safeIn.value)||0);
    const bleedPx = bleed * pxPerInPreview;
    const safePx  = safe  * pxPerInPreview;

    positionRect(trimGuide, 0, 0, previewStage.clientWidth, previewStage.clientHeight);
    positionRect(safeGuide, safePx, safePx, previewStage.clientWidth-2*safePx, previewStage.clientHeight-2*safePx);
    positionRect(bleedGuide, -bleedPx, -bleedPx, previewStage.clientWidth+2*bleedPx, previewStage.clientHeight+2*bleedPx);
  }
  function positionRect(el, left, top, w, h){
    el.style.left = left+'px'; el.style.top = top+'px'; el.style.width = Math.max(0,w)+'px'; el.style.height = Math.max(0,h)+'px';
  }
  showGuides.addEventListener('change', ()=>{
    const on = showGuides.checked;
    [trimGuide, safeGuide, bleedGuide].forEach(el=> el.classList.toggle('hidden', !on));
    if(on) layoutGuides();
  });
  [safeIn, bleedIn].forEach(inp=> inp.addEventListener('input', ()=>{ if(showGuides.checked) layoutGuides(); }));

  // ===================== Export (with resolution gate) =====================
  function requiredPixels(){ return { W: Math.round(state.inches.w*state.dpi), H: Math.round(state.inches.h*state.dpi) }; }
  function checkResolutionOk(){
    const {W,H} = requiredPixels();
    let nw = state.preview.naturalW || 0, nh = state.preview.naturalH || 0;
    if(!nw || !nh){
      nw = previewBgImg.naturalWidth; nh = previewBgImg.naturalHeight;
    }
    const ok = (nw >= W*0.95) && (nh >= H*0.95);
    if(!ok){
      const msg = `Warning: background may be too small for ${state.inches.w}×${state.inches.h} in @ ${state.dpi} dpi.\nNeed ≈ ${W}×${H}px; got ${nw||'unknown'}×${nh||'unknown'}.\n\nProceed anyway? (Cancel to go back)`;
      return confirm(msg);
    }
    return true;
  }
  function shouldDownscale(wPx, hPx){
    const MAX_SIDE = 10000, MAX_PIXELS = 80e6;
    return (wPx > MAX_SIDE || hPx > MAX_SIDE || (wPx*hPx) > MAX_PIXELS);
  }

  btnWebPng.addEventListener('click', async()=>{
    try{
      lockScroll();
      status('Generating web preview PNG…');
      await ensureFontsReady();
      const dataUrl=await html2canvas(previewStage,{
        allowTaint:false, useCORS:true, backgroundColor:'#ffffff', scale:1,
        ignoreElements: el => el.classList?.contains('export-ignore')
      }).then(c=>c.toDataURL('image/png'));
      triggerDownload(dataUrl,`poster-web-${state.size}.png`);
      status('Done.');
    } catch(e){
      handleExportError(e);
    } finally { unlockScroll(); }
  });

  btnPrintPng.addEventListener('click', async()=>{
    if(!checkResolutionOk()) return;
    await withBusy(btnPrintPng, async()=>{
      try{
        status(`Rendering print PNG (${state.dpi} dpi)…`);
        await ensureFontsReady();
        const dataUrl=await renderPrintCanvas(false).then(c=>c.toDataURL('image/png'));
        triggerDownload(dataUrl,`poster-print-${state.size}-${state.dpi}dpi.png`);
        status('Done.');
      } catch(e){ handleExportError(e); throw e; }
    });
  });

  btnPrintPdf.addEventListener('click', async()=>{
    if(!checkResolutionOk()) return;
    await withBusy(btnPrintPdf, async()=>{
      try{
        status(`Rendering print PDF (${state.dpi} dpi, true inches)…`);
        await ensureFontsReady();
        const canvas=await renderPrintCanvas(includeGuidesPdf.checked);
        const { jsPDF }=window.jspdf;
        const wIn=state.inches.w, hIn=state.inches.h;
        const pdf=new jsPDF({orientation:wIn>hIn?'l':'p', unit:'in', format:[wIn,hIn]});
        const imgData=canvas.toDataURL('image/jpeg',1);
        pdf.addImage(imgData,'JPEG',0,0,wIn,hIn);
        pdf.save(`poster-print-${state.size}-${state.dpi}dpi.pdf`);
        status('Done.');
      } catch(e){ handleExportError(e); throw e; }
    });
  });

  function handleExportError(e){
    console.error(e);
    if(isIOS()){
      alert('Export failed or blank file:\n• Please select 200 DPI from the "Print DPI" dropdown and try again;\n• Or use a computer to export the file again.');
    }else{
      alert('Export failed. Try 200 DPI or a smaller image. If the issue persists, try on a desktop.');
    }
  }

  async function renderPrintCanvas(includeGuides){
    const {w,h}=state.inches; let dpi=state.dpi;
    let W=Math.round(w*dpi), H=Math.round(h*dpi);
    if (shouldDownscale(W,H)) {
      dpi = Math.min(200, dpi); W = Math.round(w*dpi); H = Math.round(h*dpi);
      status(`Target too large → auto-downgraded to ${dpi} dpi (${W}×${H}px).`);
    }

    printStage.innerHTML=''; printStage.style.width=W+'px'; printStage.style.height=H+'px';
    const wrap=document.createElement('div');
    wrap.style.cssText=`position:relative;width:${W}px;height:${H}px;overflow:visible;background:#ffffff;`;
    const img=document.createElement('img');
    img.style.cssText='position:absolute;inset:0;width:100%;height:100%;object-fit:cover;';
    img.crossOrigin='anonymous';
    img.src=state.preview.bgLarge || state.preview.bgSmall || '';
    wrap.appendChild(img);

    const pr=previewStage.getBoundingClientRect();
    const sx=W/pr.width, sy=H/pr.height;
    const k=(sx+sy)/2;

    await new Promise(res=>{ if(!img.src){ res(); return; } img.onload=res; img.onerror=res; });

    for(const id of ['t1','t2','t3']){
      const src=texts[id];
      const srec=src.getBoundingClientRect();
      const cs=getComputedStyle(src);
      const el=document.createElement('div');
      el.textContent=src.textContent;
      el.style.position='absolute';
      el.style.left=((srec.left-pr.left)*sx)+'px';
      el.style.top =((srec.top -pr.top )*sy)+'px';
      el.style.fontSize=(parseFloat(cs.fontSize)*k)+'px';
      el.style.fontFamily=cs.fontFamily;
      el.style.color=cs.color;
      el.style.fontWeight=cs.fontWeight;
      el.style.fontStyle=cs.fontStyle;
      el.style.textDecoration=cs.textDecoration;
      el.style.textAlign=cs.textAlign;
      el.style.whiteSpace=cs.whiteSpace||'pre-wrap';
      el.style.lineHeight=(cs.lineHeight==='normal'?'1.15':cs.lineHeight);
      let sds = parseInt(src.dataset.shadowS||'0',10);
      let sblur = parseFloat(src.dataset.shadowBlur||'0');
      let scolor = src.dataset.shadowColor || '#000';
      if(sds>0){ const off=Math.max(1,Math.round(sds/10))*k; const bl=Math.max(0.5,sblur*k); el.style.textShadow=`${off}px ${off}px ${bl}px ${scolor}`; }
      wrap.appendChild(el);
    }

    if(includeGuides){
      const safe = Math.max(0, parseFloat(safeIn.value)||0);
      const bleed= Math.max(0, parseFloat(bleedIn.value)||0);
      const safePx  = safe  * (W/state.inches.w);
      const bleedPx = bleed * (W/state.inches.w);
      const trim = document.createElement('div');
      trim.style.cssText = `position:absolute;left:0;top:0;width:${W}px;height:${H}px;outline:4px dashed rgba(239,68,68,.9)`;
      const safeR = document.createElement('div');
      safeR.style.cssText = `position:absolute;left:${safePx}px;top:${safePx}px;width:${W-2*safePx}px;height:${H-2*safePx}px;outline:4px dashed rgba(34,197,94,.9)`;
      const bleedR= document.createElement('div');
      bleedR.style.cssText= `position:absolute;left:${-bleedPx}px;top:${-bleedPx}px;width:${W+2*bleedPx}px;height:${H+2*bleedPx}px;outline:4px dashed rgba(59,130,246,.9)`;
      wrap.appendChild(bleedR); wrap.appendChild(trim); wrap.appendChild(safeR);
    }

    printStage.appendChild(wrap);
    const canvas = await html2canvas(wrap, {
      allowTaint:false, useCORS:true, backgroundColor:'#ffffff', scale:1,
      windowWidth:W, windowHeight:H, letterRendering:true
    });
    return canvas;
  }

  async function withBusy(el, fn){
    const old = el.textContent;
    el.disabled = true;
    el.textContent = 'Working...';
    el.classList.add('opacity-70','cursor-wait');
    try { await fn(); }
    catch(e){ /* handled above */ }
    finally{
      el.disabled = false;
      el.textContent = old;
      el.classList.remove('opacity-70','cursor-wait');
    }
  }
  function triggerDownload(dataUrl,filename){
    const a=document.createElement('a'); a.href=dataUrl; a.download=filename; document.body.appendChild(a); a.click(); a.remove();
  }

  // ===================== localStorage Save / Load / Clear =====================
  const STORAGE_KEY = 'posterDesignV1';
  function collectDesign(){
    const txt = {};
    for(const id of Object.keys(texts)){
      const el = texts[id];
      txt[id] = {
        content: el.innerText,
        style: {
          fontSize: getComputedStyle(el).fontSize,
          color: getComputedStyle(el).color,
          fontWeight: getComputedStyle(el).fontWeight,
          fontStyle: getComputedStyle(el).fontStyle,
          textDecoration: getComputedStyle(el).textDecoration,
          textAlign: getComputedStyle(el).textAlign,
          fontFamily: getComputedStyle(el).fontFamily
        },
        pos: { leftPercent: el.dataset.leftPercent, topPercent: el.dataset.topPercent },
        shadow: { s: el.dataset.shadowS||'0', blur: el.dataset.shadowBlur||'0', color: el.dataset.shadowColor||'#000' }
      };
    }
    return {
      version:1,
      size: state.size,
      dpi: state.dpi,
      inches: state.inches,
      preview: {
        isLocal: state.preview.isLocal,
        small: state.preview.bgSmall,
        large: state.preview.bgLarge,
        naturalW: state.preview.naturalW,
        naturalH: state.preview.naturalH
      },
      ui: {
        safeIn: safeIn.value,
        bleedIn: bleedIn.value,
        showGuides: showGuides.checked,
        includeGuidesPdf: includeGuidesPdf.checked
      },
      texts: txt
    };
  }
  function applyDesign(data){
    if(!data || data.version!==1) return;
    sizeSelect.value = data.size || '24x30';
    setSize(sizeSelect.value);
    dpiSelect.value = String(data.dpi || 300);
    setDpi(dpiSelect.value);

    Object.assign(state.preview, {
      isLocal: !!data.preview?.isLocal,
      bgSmall: data.preview?.small || DEFAULT_BG[state.size].small,
      bgLarge: data.preview?.large || data.preview?.small || DEFAULT_BG[state.size].large,
      naturalW: data.preview?.naturalW || null,
      naturalH: data.preview?.naturalH || null
    });
    applyPreviewBg();

    safeIn.value = data.ui?.safeIn || '0.25';
    bleedIn.value= data.ui?.bleedIn || '0.125';
    showGuides.checked = !!data.ui?.showGuides;
    includeGuidesPdf.checked = !!data.ui?.includeGuidesPdf;
    [trimGuide, safeGuide, bleedGuide].forEach(el=> el.classList.toggle('hidden', !showGuides.checked));
    if(showGuides.checked) layoutGuides();

    Object.keys(texts).forEach(id=>{
      const el=texts[id]; const t=data.texts?.[id]; if(!t) return;
      el.innerText = t.content || el.innerText;
      el.style.fontSize = t.style?.fontSize || el.style.fontSize;
      el.style.color = t.style?.color || el.style.color;
      el.style.fontWeight = t.style?.fontWeight || el.style.fontWeight;
      el.style.fontStyle = t.style?.fontStyle || el.style.fontStyle;
      el.style.textDecoration = t.style?.textDecoration || el.style.textDecoration;
      el.style.textAlign = t.style?.textAlign || el.style.textAlign;
      el.style.fontFamily = t.style?.fontFamily || el.style.fontFamily;

      const lp = parseFloat(t.pos?.leftPercent||'');
      const tp = parseFloat(t.pos?.topPercent||'');
      if(!Number.isNaN(lp) && !Number.isNaN(tp)){
        el.style.left = `${lp}%`; el.style.top = `${tp}%`;
        el.dataset.leftPercent = String(lp); el.dataset.topPercent = String(tp);
      } else {
        normalizePercentPosition(el, previewStage);
      }

      const s=parseInt(t.shadow?.s||'0',10);
      const bl=parseFloat(t.shadow?.blur||'0');
      const col=t.shadow?.color||'#000';
      el.dataset.shadowS = String(s);
      el.dataset.shadowBlur = String(bl);
      el.dataset.shadowColor = col;
      const off=Math.round(s/10)||0;
      el.style.textShadow = s===0 ? 'none' : `${off}px ${off}px ${bl}px ${col}`;
    });

    status('Design loaded.');
  }
  btnSave.addEventListener('click', ()=>{
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(collectDesign()));
      status('Design saved to this browser (localStorage).');
    }catch(e){ alert('Save failed (quota exceeded?)'); }
  });
  btnLoad.addEventListener('click', ()=>{
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){ alert('No saved design found.'); return; }
      applyDesign(JSON.parse(raw));
    }catch(e){ alert('Load failed (corrupted data).'); }
  });
  btnClear.addEventListener('click', ()=>{
    localStorage.removeItem(STORAGE_KEY);
    status('Saved design cleared.');
  });

  // ===================== Controls wiring =====================
  sizeSelect.addEventListener('change',e=>setSize(e.target.value));
  dpiSelect.addEventListener('change',e=>setDpi(e.target.value));
  guideSelect.addEventListener('change',e=>{
    const on=e.target.value==='on';
    guideH.classList.toggle('hidden',!on);
    guideV.classList.toggle('hidden',!on);
  });

  document.querySelectorAll('.pickTarget').forEach(btn=>{
    btn.addEventListener('click',()=> setActiveText(btn.dataset.target));
  });

  // ===================== First render =====================
  t1.style.fontFamily="'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif";
  t2.style.fontFamily="'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif";
  t3.style.fontFamily="'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif";

  normalizePercentPosition(t1, previewStage);
  normalizePercentPosition(t2, previewStage);
  normalizePercentPosition(t3, previewStage);

  setSize('24x30');
  setDpi(dpiSelect.value);
  applyPreviewBg();
  buildThumbs();
  setActiveText(state.activeTextId);
  layoutGuides();
  status('Ready. Choose a background, edit texts, and export.');
  </script>
</body>
</html>

